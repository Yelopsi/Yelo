<!DOCTYPE html>
<html lang="pt-br">
<head>
    <title><%= post.titulo %> | Blog Yelo</title>
    <meta name="description" content="<%= post.conteudo.substring(0, 160) %>">
    <%- include('partials/head') %>
    
    <style>
        /* CONFIGURAÇÃO DA PÁGINA */
        .pagina-artigo {
            padding-top: 140px; /* Espaço para o menu fixo */
            padding-bottom: 80px;
            background-color: #fdfaf6;
            min-height: 100vh;
        }

        .container-leitura {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 2fr 1fr; /* Coluna Principal (2) e Sidebar (1) */
            gap: 60px; /* Espaço entre o texto e a lateral */
            align-items: start;
        }

        /* --- COLUNA ESQUERDA: ARTIGO --- */
        .artigo-principal {
            background: transparent;
        }

        /* Cabeçalho do Artigo (Sem banner verde) */
        .artigo-header-clean {
            margin-bottom: 30px;
        }
        .categoria-tag {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #1B4332;
            font-weight: bold;
            display: block;
            margin-bottom: 10px;
        }
        .titulo-principal {
            font-family: 'New Kansas', serif;
            font-size: 3rem;
            color: #1B4332;
            line-height: 1.1;
            margin: 0 0 20px 0;
        }

        /* Autor e Data */
        .meta-info {
            display: flex;
            align-items: center;
            gap: 15px;
            border-top: 1px solid #e0e0e0;
            border-bottom: 1px solid #e0e0e0;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        .autor-mini {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #333;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .autor-mini img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .data-mini { color: #666; font-size: 0.9rem; }

        /* Imagem Principal */
        .imagem-destaque-artigo {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: cover;
            border-radius: 12px;
            margin-bottom: 40px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        }

        /* Texto do Artigo */
        .conteudo-texto {
            font-family: 'Georgia', serif; /* Fonte serifada para leitura confortável */
            font-size: 1.25rem;
            line-height: 1.8;
            color: #2c3e50;
            text-align: justify; /* Justificado conforme pedido */
        }
        .conteudo-texto p { margin-bottom: 25px; }

        /* --- COLUNA DIREITA: SIDEBAR --- */
        .sidebar-artigos {
            position: sticky;
            top: 140px; /* Fica fixo enquanto rola a tela */
            padding-left: 20px;
            border-left: 1px solid #eee;
        }

        .sidebar-titulo {
            font-family: 'New Kansas', serif;
            font-size: 1.5rem;
            color: #1B4332;
            margin-bottom: 25px;
        }

        .card-lateral {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            text-decoration: none;
            color: inherit;
            align-items: center;
            transition: transform 0.2s;
        }
        .card-lateral:hover { transform: translateX(5px); }

        .card-lateral img {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .card-lateral-info h4 {
            font-family: 'New Kansas', serif;
            font-size: 1.1rem;
            margin: 0 0 5px 0;
            line-height: 1.3;
            color: #333;
        }
        .card-lateral-info span {
            font-size: 0.8rem;
            color: #888;
        }

        /* --- RESPONSIVIDADE --- */
        @media (max-width: 900px) {
            .container-leitura {
                grid-template-columns: 1fr; /* Vira uma coluna só no celular */
                gap: 40px;
            }
            .sidebar-artigos {
                padding-left: 0;
                border-left: none;
                border-top: 1px solid #eee;
                padding-top: 40px;
            }
            .titulo-principal { font-size: 2.2rem; }
        }
    </style>
</head>
<body>

<%- include('partials/header') %>

<main class="pagina-artigo">
    
    <div class="container-leitura">
        
        <article class="artigo-principal">
            
            <div class="artigo-header-clean">
                <span class="categoria-tag">Blog Yelo</span>
                <h1 class="titulo-principal"><%= post.titulo %></h1>
                
                <div class="meta-info">
                    <div class="autor-mini">
                        <img src="<%= post.autor && post.autor.fotoUrl ? formatImageUrl(post.autor.fotoUrl) : 'https://placehold.co/40x40' %>" alt="Autor">
                        <span>Psi. <%= post.autor ? post.autor.nome.split(' ')[0] : 'Yelo' %></span>
                    </div>
                    <span class="data-mini">
                        <%= new Date(post.created_at).toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' }) %>
                    </span>
                </div>
            </div>

            <img src="<%= post.imagem_url || getImagemFixa(post.id) %>" alt="<%= post.titulo %>" class="imagem-destaque-artigo">

            <div class="conteudo-texto">
                <% post.conteudo.split('\n').forEach(paragrafo => { %>
                    <% if (paragrafo.trim()) { %>
                        <p><%= paragrafo %></p>
                    <% } %>
                <% }) %>
            </div>

            <div style="margin: 40px 0; padding: 20px 0; border-top: 1px solid #eee; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                
                <button onclick="darLikeInterno('<%= post.id %>')" id="btn-like-interno" style="background: none; border: 1px solid #ddd; padding: 8px 24px; border-radius: 50px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: #555; transition: all 0.2s;">
                    <svg id="icon-heart-interno" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                    <span style="font-weight: 600; font-family: 'Lato', sans-serif;">Curtir (<span id="count-interno"><%= post.curtidas || 0 %></span>)</span>
                </button>

                <button onclick="compartilharPost()" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; color: #1B4332; font-weight: 600;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M13.5 1a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zM11 2.5a2.5 2.5 0 1 1 .603 1.628l-6.718 3.12a2.499 2.499 0 0 1 0 1.504l6.718 3.12a2.5 2.5 0 1 1-.488.876l-6.718-3.12a2.5 2.5 0 1 1 0-3.256l6.718-3.12A2.5 2.5 0 0 1 11 2.5zm-8.5 4a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3zm11 5.5a1.5 1.5 0 1 0 0 3 1.5 1.5 0 0 0 0-3z"/>
                    </svg>
                    Compartilhar
                </button>
            </div>
            
            <script>
                // Verifica ao carregar se já curtiu este post específico
                document.addEventListener("DOMContentLoaded", function() {
                    const postId = '<%= post.id %>';
                    if (localStorage.getItem('liked_' + postId)) {
                        marcarComoCurtido();
                    }
                });

                function marcarComoCurtido() {
                    const btn = document.getElementById('btn-like-interno');
                    const svg = document.getElementById('icon-heart-interno');
                    
                    // Muda visual para "Ativo"
                    svg.setAttribute('fill', '#e63946'); // Preenche de vermelho
                    svg.setAttribute('stroke', '#e63946'); // Borda vermelha
                    btn.style.borderColor = "#e63946";
                    btn.style.color = "#e63946";
                    btn.classList.add('liked');
                }

                function desmarcarCurtida() {
                    const btn = document.getElementById('btn-like-interno');
                    const svg = document.getElementById('icon-heart-interno');
                    
                    // Volta visual para "Normal"
                    svg.setAttribute('fill', 'none'); 
                    svg.setAttribute('stroke', 'currentColor');
                    btn.style.borderColor = "#ddd";
                    btn.style.color = "#555";
                    btn.classList.remove('liked');
                }

                async function darLikeInterno(postId) {
                    const btn = document.getElementById('btn-like-interno');
                    const count = document.getElementById('count-interno');
                    const jaCurtiu = localStorage.getItem('liked_' + postId);
                    const action = jaCurtiu ? 'unlike' : 'like'; // Decide se soma ou subtrai

                    try {
                        const response = await fetch(`/blog/post/${postId}/like`, { 
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ action: action }) 
                        });
                        const data = await response.json();
                        
                        if (data.success) {
                            count.innerText = data.curtidas;
                            
                            if (action === 'like') {
                                localStorage.setItem('liked_' + postId, 'true'); // Salva no navegador
                                marcarComoCurtido();
                            } else {
                                localStorage.removeItem('liked_' + postId); // Remove do navegador
                                desmarcarCurtida();
                            }
                        }
                    } catch (e) { console.error(e); }
                }
                function compartilharPost() {
                    if (navigator.share) {
                        navigator.share({ title: '<%= post.titulo %>', url: window.location.href }).catch(console.error);
                    } else {
                        navigator.clipboard.writeText(window.location.href);
                        alert('Link copiado!');
                    }
                }
            </script>

            <div style="margin-top: 50px; text-align: center;">
                <a href="/blog" style="display: inline-block; padding: 10px 30px; border: 1px solid #1B4332; border-radius: 25px; text-decoration: none; color: #1B4332; font-weight: bold;">
                    ← Voltar para o Blog
                </a>
            </div>
        </article>


        <aside class="sidebar-artigos">
            <h3 class="sidebar-titulo">Leia também</h3>
            
            <% if (recentes && recentes.length > 0) { %>
                <% recentes.forEach(item => { %>
                    <a href="/blog/post/<%= item.id %>" class="card-lateral">
                        <img src="<%= item.imagem_url || getImagemFixa(item.id) %>" alt="Capa">
                        <div class="card-lateral-info">
                            <h4><%= item.titulo %></h4>
                            <span><%= new Date(item.created_at).toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' }) %></span>
                        </div>
                    </a>
                <% }) %>
            <% } else { %>
                <p style="color: #999; font-size: 0.9rem;">Sem outras sugestões no momento.</p>
            <% } %>

            <div style="background: #E0F2F1; padding: 25px; border-radius: 12px; margin-top: 40px; text-align: center;">
                <h4 style="color: #1B4332; font-family: 'New Kansas', serif; margin-top: 0;">Precisa conversar?</h4>
                <p style="font-size: 0.9rem; color: #555;">Nossos profissionais estão prontos para te ouvir.</p>
                <a href="/questionario.html" style="display: inline-block; background: #1B4332; color: #fff; padding: 8px 20px; border-radius: 20px; text-decoration: none; font-size: 0.85rem; margin-top: 10px;">Encontrar Psicólogo</a>
            </div>
        </aside>

    </div>

</main>

<%- include('partials/footer') %>

</body>
</html>
