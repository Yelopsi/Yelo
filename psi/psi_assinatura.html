<div class="main-header">
    <div class="header-content">
        <h1>Gerencie sua Assinatura</h1>
        <p>Escolha o plano que melhor se alinha ao seu momento profissional.</p>
    </div>
</div>

<!-- BANNER VIP (Invis√≠vel por padr√£o) -->
<div id="vip-banner" style="display: none; margin: 20px auto; max-width: 900px; background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%); border: 1px solid #86efac; border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
    <div style="font-size: 3rem; margin-bottom: 15px;">üíé</div>
    <h2 style="color: #166534; margin-bottom: 10px; font-size: 1.8rem;">Status VIP Ativo</h2>
    <p style="color: #15803d; font-size: 1.1rem; max-width: 600px; margin: 0 auto;">
        Sua isen√ß√£o para o <strong id="vip-plan-name">Plano Essencial</strong> foi concedida pela administra√ß√£o da Yelo.
    </p>
    <p style="color: #16a34a; font-size: 0.9rem; margin-top: 15px;">
        Aproveite todos os recursos premium sem custo. Obrigado por ser um parceiro essencial!
    </p>
</div>

            <section id="card-resumo-assinatura" class="plano-atual-moderno" style="display: none;">
                <div class="info-lado-esquerdo">
                    <div class="nome-plano-banner" id="banner-nome-plano">--</div>
                    
                    <div class="status-badge">
                        <span style="width: 8px; height: 8px; background: #4ade80; border-radius: 50%;"></span>
                        Ativo e Validado
                    </div>
                </div>
                
                <div class="info-lado-direito">
                    <div class="preco-destaque" id="banner-preco" style="font-size: 1.8rem; font-weight: 700;">R$ -- / m√™s</div>
                    <span class="data-renovacao" id="banner-renovacao" style="display:block; text-align:right; opacity:0.8; margin-top:5px; font-size:0.9rem;">Renova em: --/--/----</span>
                </div>
            </section>

<section class="planos-grid">
    <div class="plano-card promo-ativa" id="card-plano-essencial">
        <div class="tag-oferta-topo" id="tag-oferta-essencial">
            üî• 3 Meses com 50% OFF
        </div>
        <h2>Plano Essencial</h2>
        <div class="preco-desconto" id="preco-essencial">
            <span class="preco-antigo">R$ 99</span>
            <span class="preco-novo">R$ 49,50</span>
            <span>/m√™s</span>
        </div>
        <ul class="beneficios-lista">
            <li>‚úÖ Participa√ß√£o no Match</li>
            <li>‚úÖ Indicadores Simples (Views/Cliques)</li>
            <li>‚úÖ P√°gina P√∫blica de Divulga√ß√£o</li>
            <li>‚úÖ F√≥rum de Discuss√µes</li>
        </ul>
        <div class="plano-cta">
            <button class="btn-mudar-plano btn-upgrade" data-plano="ESSENTIAL" style="width: 100%;">QUERO COME√áAR AGORA üöÄ</button>
            <p style="font-size: 0.75rem; color: #888; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 5px;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lock" style="width: 12px; height: 12px;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Pagamento seguro</p>
        </div>
    </div>

    <div class="plano-card destaque-visual" style="border: 2px solid #ccc; opacity: 0.8; position: relative;">
        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #999; color: #fff; font-size: 0.75rem; font-weight: bold; padding: 2px 10px; border-radius: 12px;">
            EM BREVE
        </div>
        <h2 style="color: #666;">Plano Cl√≠nico</h2>
        <div class="preco" style="color: #666;">R$ 159<span>/m√™s</span></div>
        <ul class="beneficios-lista" style="filter: grayscale(100%);">
            <li>‚ú® <strong>Tudo do Essencial, mais:</strong></li>
            <li>‚úÖ Intervis√£o e Workshops</li>
            <li>‚úÖ Perguntas e Respostas</li>
            <li>‚úÖ Indicadores (Convers√£o e Picos)</li>
            <li>‚úÖ URL Personalizada</li>
        </ul>
        <div class="plano-cta">
            <button class="btn-mudar-plano" disabled style="background-color: #e0e0e0; color: #888; border: none; cursor: not-allowed; width: 100%;">
                Dispon√≠vel em Breve
            </button>
        </div>
    </div>

    <div class="plano-card" style="border: 2px solid #eee; opacity: 0.7; position: relative;">
        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #999; color: #fff; font-size: 0.75rem; font-weight: bold; padding: 2px 10px; border-radius: 12px;">
            EM BREVE
        </div>
        <h2 style="color: #666;">Plano Refer√™ncia</h2>
        <div class="preco" style="color: #666;">R$ 259<span>/m√™s</span></div>
        <ul class="beneficios-lista" style="filter: grayscale(100%);">
            <li>üöÄ <strong>Tudo do Cl√≠nico, mais:</strong></li>
            <li>‚úÖ Supervis√£o Cl√≠nica</li>
            <li>‚úÖ Destaque nos Resultados</li>
            <li>‚úÖ An√°lise de Perfil com IA</li>
            <li>‚úÖ Insights Avan√ßados (Competitividade)</li>
        </ul>
        <div class="plano-cta">
            <button class="btn-mudar-plano" disabled style="background-color: #e0e0e0; color: #888; border: none; cursor: not-allowed; width: 100%;">
                Dispon√≠vel em Breve
            </button>
        </div>
    </div>
</section>

<div id="area-cancelamento" class="danger-zone" style="display: none;">
    <p style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">Deseja encerrar sua assinatura?</p>
    <button id="btn-cancelar-assinatura" class="btn-cancelar-discreto">
        Cancelar renova√ß√£o autom√°tica
    </button>
</div>

<div id="modal-cancelamento" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box">
        <div style="margin-bottom: 20px; color: #e63946;">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
            </svg>
        </div>
        <h3 style="margin-bottom: 10px; color: #333;">Tem certeza?</h3>
        <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">
            Voc√™ continuar√° com acesso aos benef√≠cios at√© o fim do per√≠odo pago, mas sua assinatura n√£o ser√° renovada.
        </p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="btn-fechar-modal-cancel" style="padding: 10px 20px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; color: #555;">Manter Plano</button>
            <button id="btn-confirmar-cancelamento" style="padding: 10px 20px; border: none; background: #e63946; border-radius: 6px; cursor: pointer; color: #fff; font-weight: bold;">Sim, Cancelar</button>
        </div>
    </div>
</div>

<div id="modal-sucesso-cancelamento" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box" style="text-align: center;">
        <div style="margin-bottom: 20px; color: #1B4332;">
            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
        </div>
        <h3 style="margin-top:0; color: #1B4332; font-size: 1.5rem;">Tudo Certo!</h3>
        <p id="msg-sucesso-cancelamento" style="color:#666; line-height: 1.6; margin-bottom: 25px; font-size: 1.1rem;">
            Assinatura cancelada e valor estornado.
        </p>
        <button id="btn-fechar-sucesso-cancel" style="background-color: #1B4332; color: white; padding: 12px 35px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; transition: transform 0.2s; font-size: 1rem; width: 100%;">
            Entendido
        </button>
    </div>
</div>

<script>
(async () => {
    const BASE_URL = (typeof window.API_BASE_URL !== 'undefined') ? window.API_BASE_URL : 'http://localhost:3001';
    const token = localStorage.getItem('Yelo_token');

    if (!token) return; // Se n√£o estiver logado, o comportamento padr√£o (mostrar planos) permanece ou redireciona

    try {
        // Busca dados atualizados do perfil
        // Adiciona timestamp para evitar cache do navegador
        const response = await fetch(`${BASE_URL}/api/psychologists/me?t=${new Date().getTime()}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const user = await response.json();
            console.log("Debug Assinatura - Dados do Usu√°rio:", user);

            // VERIFICA√á√ÉO VIP
            // Verifica se √© VIP pela flag OU pelo plano (fallback de seguran√ßa)
            // Se o usu√°rio tem plano REFERENCE ou CLINICAL, tratamos como VIP automaticamente
            const isVip = user.is_exempt || (user.plano && ['REFERENCE', 'CLINICAL'].includes(user.plano));

            if (isVip) {
                aplicarModoVip(user.plano);
            } else if (user.plano) {
                // [CORRE√á√ÉO] Mostra √°rea de cancelamento se tiver plano, n√£o for VIP e N√ÉO estiver cancelado
                const areaCancel = document.getElementById('area-cancelamento');
                if (areaCancel) {
                    if (user.cancelAtPeriodEnd) {
                        // [CORRE√á√ÉO] Se j√° estiver cancelado, esconde o bot√£o de cancelar
                        areaCancel.style.display = 'none';
                        
                        // E atualiza o badge de status para "Cancelamento Agendado"
                        const statusBadge = document.querySelector('.status-badge');
                        if(statusBadge) {
                            statusBadge.innerHTML = '<span style="width: 8px; height: 8px; background: #F59E0B; border-radius: 50%;"></span> Cancelamento Agendado';
                            statusBadge.style.backgroundColor = '#FFFBEB';
                            statusBadge.style.color = '#B45309';
                            statusBadge.style.borderColor = '#FCD34D';
                        }
                    } else {
                        areaCancel.style.display = 'block';
                    }
                }

                // Usu√°rio tem um plano ativo: REMOVE o badge de promo√ß√£o
                const promoBadge = document.getElementById('tag-oferta-essencial');
                if (promoBadge) {
                    promoBadge.remove();
                }

                // Remove o destaque visual (borda verde) do card promocional
                const promoCard = document.getElementById('card-plano-essencial');
                if (promoCard) {
                    promoCard.classList.remove('promo-ativa');
                }

                // Se o plano atual for o Essencial, ajusta o bot√£o para indicar isso
                if (user.plano === 'ESSENTIAL') {
                    const btnEssencial = document.querySelector('#card-plano-essencial .btn-mudar-plano');
                    if (btnEssencial) {
                        // L√ìGICA DE REATIVA√á√ÉO
                        if (user.cancelAtPeriodEnd) {
                            // Modo: Cancelamento Agendado -> Bot√£o vira "Reativar"
                            btnEssencial.textContent = 'Reativar Assinatura ‚Ü∫';
                            btnEssencial.disabled = false;
                            btnEssencial.style.backgroundColor = '#F59E0B'; // Cor de alerta/a√ß√£o
                            btnEssencial.style.borderColor = '#F59E0B';
                            btnEssencial.style.color = '#fff';
                            btnEssencial.style.cursor = 'pointer';
                            
                            // A√ß√£o de Reativar
                            btnEssencial.onclick = async (e) => {
                                e.preventDefault();
                                if(!confirm('Deseja reativar sua assinatura? A cobran√ßa voltar√° a ocorrer na data prevista.')) return;
                                
                                try {
                                    const res = await fetch(`${BASE_URL}/api/psychologists/me/reactivate-subscription`, {
                                        method: 'POST',
                                        headers: { 'Authorization': `Bearer ${token}` }
                                    });
                                    const d = await res.json();
                                    if(res.ok) { alert(d.message); window.location.reload(); }
                                    else { alert(d.error); window.location.reload(); } // Se der erro (ex: deletado), recarrega para mostrar form
                                } catch(err) { alert('Erro ao reativar.'); }
                            };
                        } else {
                            // Modo: Ativo Normal
                            btnEssencial.textContent = 'Seu Plano Atual';
                            btnEssencial.disabled = true;
                            btnEssencial.style.backgroundColor = '#e0e0e0';
                            btnEssencial.style.borderColor = '#e0e0e0';
                            btnEssencial.style.color = '#888';
                            btnEssencial.style.cursor = 'default';
                        }
                    }
                }
            }
        }
    } catch (error) {
        console.error("Erro ao verificar status VIP:", error);
    }

    // --- L√ìGICA DE CANCELAMENTO (ADICIONADO) ---
    const btnCancel = document.getElementById('btn-cancelar-assinatura');
    const modalCancel = document.getElementById('modal-cancelamento');
    const btnCloseModal = document.getElementById('btn-fechar-modal-cancel');
    const btnConfirmCancel = document.getElementById('btn-confirmar-cancelamento');

    // Abrir Modal
    if (btnCancel && modalCancel) {
        btnCancel.onclick = () => modalCancel.style.display = 'flex';
    }
    // Fechar Modal
    if (btnCloseModal && modalCancel) {
        btnCloseModal.onclick = () => modalCancel.style.display = 'none';
    }
    // Confirmar Cancelamento
    if (btnConfirmCancel) {
        btnConfirmCancel.onclick = async () => {
            btnConfirmCancel.disabled = true;
            btnConfirmCancel.textContent = 'Processando...';

            try {
                const res = await fetch(`${BASE_URL}/api/psychologists/me/cancel-subscription`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (res.ok) {
                    // Fecha o modal de confirma√ß√£o
                    modalCancel.style.display = 'none';
                    
                    // Abre o modal de sucesso personalizado
                    const modalSuccess = document.getElementById('modal-sucesso-cancelamento');
                    const msgEl = document.getElementById('msg-sucesso-cancelamento');
                    const btnClose = document.getElementById('btn-fechar-sucesso-cancel');
                    
                    if (modalSuccess) {
                        if (msgEl) msgEl.textContent = data.message || 'Assinatura cancelada com sucesso.';
                        modalSuccess.style.display = 'flex';
                        if (btnClose) btnClose.onclick = () => window.location.reload();
                    } else {
                        // Fallback caso o modal n√£o carregue
                        alert(data.message || 'Assinatura cancelada com sucesso.');
                        window.location.reload();
                    }
                } else {
                    // Mesmo com erro, pode ser que o estado tenha mudado.
                    console.error("Erro cancelamento:", data);
                    alert(data.error || 'Houve um problema, mas vamos atualizar a p√°gina para verificar o status.');
                    window.location.reload();
                }
            } catch (err) {
                console.error(err);
                alert('Erro de conex√£o. A p√°gina ser√° recarregada.');
                window.location.reload();
            }
        };
    }

    function aplicarModoVip(planName) {
        // Mapeamento de nomes dos planos para exibi√ß√£o amig√°vel
        const nomesPlanos = {
            'ESSENTIAL': 'Essencial',
            'CLINICAL': 'Cl√≠nico',
            'REFERENCE': 'Refer√™ncia'
        };
        const nomeExibicao = nomesPlanos[planName] || planName || 'Essencial';

        const planNameEl = document.getElementById('vip-plan-name');
        if (planNameEl) planNameEl.textContent = `Plano ${nomeExibicao}`;

        // 1. Esconde a grid de planos (pagamento)
        const planosGrid = document.querySelector('.planos-grid');
        if (planosGrid) planosGrid.style.setProperty('display', 'none', 'important');

        // 2. Esconde √°rea de cancelamento (n√£o faz sentido para isentos)
        const areaCancel = document.getElementById('area-cancelamento');
        if (areaCancel) areaCancel.style.setProperty('display', 'none', 'important');

        // 3. MOSTRA o resumo de assinatura adaptado para VIP
        const resumo = document.getElementById('card-resumo-assinatura');
        if (resumo) {
            resumo.style.display = 'flex'; // Mostra o card
            
            // Atualiza textos para refletir isen√ß√£o
            const nomePlano = document.getElementById('banner-nome-plano');
            if(nomePlano) nomePlano.textContent = `Plano ${nomeExibicao}`;
            
            const preco = document.getElementById('banner-preco');
            if(preco) preco.textContent = 'R$ 0,00 (Isento)';
            
            const renovacao = document.getElementById('banner-renovacao');
            if(renovacao) renovacao.textContent = 'Status: Isento';

            // Estiliza o badge de status
            const badge = resumo.querySelector('.status-badge');
            if(badge) {
                badge.innerHTML = 'üíé VIP Ativo';
                badge.style.backgroundColor = '#e6fffa';
                badge.style.color = '#1B4332';
                badge.style.borderColor = '#1B4332';
            }
        }

        // 4. Mostra o Banner VIP
        const vipBanner = document.getElementById('vip-banner');
        if (vipBanner) vipBanner.style.display = 'block';

        // 5. Ajusta o texto do cabe√ßalho para refletir o status VIP
        const headerTitle = document.querySelector('.main-header h1');
        const headerDesc = document.querySelector('.main-header p');
        if (headerTitle) headerTitle.textContent = 'Sua Assinatura VIP';
        if (headerDesc) headerDesc.textContent = 'Voc√™ possui acesso especial concedido pela Yelo.';
    }
})();
</script>