<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

<div class="main-header">
    <div class="header-content">
        <h1>Gerencie sua Assinatura</h1>
        <p>Escolha o plano que melhor se alinha ao seu momento profissional.</p>
    </div>
</div>

<!-- BANNER VIP (Invis√≠vel por padr√£o) -->
<div id="vip-banner" style="display: none; margin: 20px auto; max-width: 900px; background: linear-gradient(135deg, #dcfce7 0%, #f0fdf4 100%); border: 1px solid #86efac; border-radius: 16px; padding: 30px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05);">
    <div style="font-size: 3rem; margin-bottom: 15px;">üíé</div>
    <h2 style="color: #166534; margin-bottom: 10px; font-size: 1.8rem;">Status VIP Ativo</h2>
    <p style="color: #15803d; font-size: 1.1rem; max-width: 600px; margin: 0 auto;">
        Sua isen√ß√£o para o <strong id="vip-plan-name">Plano Essencial</strong> foi concedida pela administra√ß√£o da Yelo.
    </p>
    <p style="color: #16a34a; font-size: 0.9rem; margin-top: 15px;">
        Aproveite todos os recursos premium sem custo. Obrigado por ser um parceiro essencial!
    </p>
</div>

            <section id="card-resumo-assinatura" class="plano-atual-moderno" style="display: none;">
                <div class="info-lado-esquerdo">
                    <div class="nome-plano-banner" id="banner-nome-plano">--</div>
                    
                    <div class="status-badge">
                        <span style="width: 8px; height: 8px; background: #4ade80; border-radius: 50%;"></span>
                        Ativo e Validado
                    </div>
                </div>
                
                <div class="info-lado-direito">
                    <div class="preco-destaque" id="banner-preco" style="font-size: 1.8rem; font-weight: 700;">R$ -- / m√™s</div>
                    <span class="data-renovacao" id="banner-renovacao" style="display:block; text-align:right; opacity:0.8; margin-top:5px; font-size:0.9rem;">Renova em: --/--/----</span>
                </div>
            </section>

<section class="planos-grid">
    <div class="plano-card promo-ativa" id="card-plano-essencial">
        <div class="tag-oferta-topo" id="tag-oferta-essencial">
            üî• 3 Meses com 50% OFF
        </div>
        <h2>Plano Essencial</h2>
        <div class="preco-desconto" id="preco-essencial">
            <span class="preco-antigo">R$ 99</span>
            <span class="preco-novo">R$ 49,50</span>
            <span>/m√™s</span>
        </div>
        <ul class="beneficios-lista">
            <li>‚úÖ Participa√ß√£o no Match</li>
            <li>‚úÖ Indicadores Simples (Views/Cliques)</li>
            <li>‚úÖ P√°gina P√∫blica de Divulga√ß√£o</li>
            <li>‚úÖ F√≥rum de Discuss√µes</li>
        </ul>
        <div class="plano-cta">
            <button class="btn-mudar-plano btn-upgrade" data-plano="ESSENTIAL" style="width: 100%;">QUERO COME√áAR AGORA üöÄ</button>
            <p style="font-size: 0.75rem; color: #888; margin-top: 8px; display: flex; align-items: center; justify-content: center; gap: 5px;"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-lock" style="width: 12px; height: 12px;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg> Pagamento seguro</p>
        </div>
    </div>

    <div class="plano-card destaque-visual" style="border: 2px solid #ccc; opacity: 0.8; position: relative;">
        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #999; color: #fff; font-size: 0.75rem; font-weight: bold; padding: 2px 10px; border-radius: 12px;">
            EM BREVE
        </div>
        <h2 style="color: #666;">Plano Cl√≠nico</h2>
        <div class="preco" style="color: #666;">R$ 159<span>/m√™s</span></div>
        <ul class="beneficios-lista" style="filter: grayscale(100%);">
            <li>‚ú® <strong>Tudo do Essencial, mais:</strong></li>
            <li>‚úÖ Intervis√£o e Workshops</li>
            <li>‚úÖ Perguntas e Respostas</li>
            <li>‚úÖ Indicadores (Convers√£o e Picos)</li>
            <li>‚úÖ URL Personalizada</li>
        </ul>
        <div class="plano-cta">
            <button class="btn-mudar-plano" disabled style="background-color: #e0e0e0; color: #888; border: none; cursor: not-allowed; width: 100%;">
                Dispon√≠vel em Breve
            </button>
        </div>
    </div>

    <div class="plano-card" style="border: 2px solid #eee; opacity: 0.7; position: relative;">
        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #999; color: #fff; font-size: 0.75rem; font-weight: bold; padding: 2px 10px; border-radius: 12px;">
            EM BREVE
        </div>
        <h2 style="color: #666;">Plano Refer√™ncia</h2>
        <div class="preco" style="color: #666;">R$ 259<span>/m√™s</span></div>
        <ul class="beneficios-lista" style="filter: grayscale(100%);">
            <li>üöÄ <strong>Tudo do Cl√≠nico, mais:</strong></li>
            <li>‚úÖ Supervis√£o Cl√≠nica</li>
            <li>‚úÖ Destaque nos Resultados</li>
            <li>‚úÖ An√°lise de Perfil com IA</li>
            <li>‚úÖ Insights Avan√ßados (Competitividade)</li>
        </ul>
        <div class="plano-cta">
            <button class="btn-mudar-plano" disabled style="background-color: #e0e0e0; color: #888; border: none; cursor: not-allowed; width: 100%;">
                Dispon√≠vel em Breve
            </button>
        </div>
    </div>
</section>

<div id="area-cancelamento" class="danger-zone" style="display: none;">
    <p style="color: #666; font-size: 0.9rem; margin-bottom: 10px;">Deseja encerrar sua assinatura?</p>
    <button id="btn-cancelar-assinatura" class="btn-cancelar-discreto">
        Cancelar renova√ß√£o autom√°tica
    </button>
</div>

<div id="modal-cancelamento" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box">
        <div style="margin-bottom: 20px; color: #e63946;">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
            </svg>
        </div>
        <h3 style="margin-bottom: 10px; color: #333;">Tem certeza?</h3>
        <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">
            Voc√™ continuar√° com acesso aos benef√≠cios at√© o fim do per√≠odo pago, mas sua assinatura n√£o ser√° renovada.
        </p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="btn-fechar-modal-cancel" style="padding: 10px 20px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; color: #555;">Manter Plano</button>
            <button id="btn-confirmar-cancelamento" style="padding: 10px 20px; border: none; background: #e63946; border-radius: 6px; cursor: pointer; color: #fff; font-weight: bold;">Sim, Cancelar</button>
        </div>
    </div>
</div>

<div id="modal-sucesso-cancelamento" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box" style="text-align: center;">
        <div style="margin-bottom: 20px; color: #1B4332;">
            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="currentColor" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
            </svg>
        </div>
        <h3 style="margin-top:0; color: #1B4332; font-size: 1.5rem;">Tudo Certo!</h3>
        <p id="msg-sucesso-cancelamento" style="color:#666; line-height: 1.6; margin-bottom: 25px; font-size: 1.1rem;">
            Assinatura cancelada e valor estornado.
        </p>
        <button id="btn-fechar-sucesso-cancel" style="background-color: #1B4332; color: white; padding: 12px 35px; border-radius: 50px; font-weight: bold; border: none; cursor: pointer; transition: transform 0.2s; font-size: 1rem; width: 100%;">
            Entendido
        </button>
    </div>
</div>

<script>
(async () => {
    const BASE_URL = (typeof window.API_BASE_URL !== 'undefined') ? window.API_BASE_URL : 'http://localhost:3001';
    const token = localStorage.getItem('Yelo_token');

    if (!token) return; // Se n√£o estiver logado, o comportamento padr√£o (mostrar planos) permanece ou redireciona

    try {
        // Busca dados atualizados do perfil
        // Adiciona timestamp para evitar cache do navegador
        const response = await fetch(`${BASE_URL}/api/psychologists/me?t=${new Date().getTime()}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (response.ok) {
            const user = await response.json();
            console.log("Debug Assinatura - Dados do Usu√°rio:", user);

            // VERIFICA√á√ÉO VIP
            // Verifica se √© VIP pela flag OU pelo plano (fallback de seguran√ßa)
            // Se o usu√°rio tem plano REFERENCE ou CLINICAL, tratamos como VIP automaticamente
            const isVip = user.is_exempt || (user.plano && ['REFERENCE', 'CLINICAL'].includes(user.plano));

            if (isVip) {
                aplicarModoVip(user.plano);
            } else if (user.plano) {
                // [CORRE√á√ÉO] Mostra √°rea de cancelamento se tiver plano, n√£o for VIP e N√ÉO estiver cancelado
                const areaCancel = document.getElementById('area-cancelamento');
                if (areaCancel) {
                    if (user.cancelAtPeriodEnd) {
                        // [CORRE√á√ÉO] Se j√° estiver cancelado, esconde o bot√£o de cancelar
                        areaCancel.style.display = 'none';
                        
                        // E atualiza o badge de status para "Cancelamento Agendado"
                        const statusBadge = document.querySelector('.status-badge');
                        if(statusBadge) {
                            statusBadge.innerHTML = '<span style="width: 8px; height: 8px; background: #F59E0B; border-radius: 50%;"></span> Cancelamento Agendado';
                            statusBadge.style.backgroundColor = '#FFFBEB';
                            statusBadge.style.color = '#B45309';
                            statusBadge.style.borderColor = '#FCD34D';
                        }
                    } else {
                        areaCancel.style.display = 'block';
                    }
                }

                // Usu√°rio tem um plano ativo: REMOVE o badge de promo√ß√£o
                const promoBadge = document.getElementById('tag-oferta-essencial');
                if (promoBadge) {
                    promoBadge.remove();
                }

                // Remove o destaque visual (borda verde) do card promocional
                const promoCard = document.getElementById('card-plano-essencial');
                if (promoCard) {
                    promoCard.classList.remove('promo-ativa');
                }

                // Se o plano atual for o Essencial, ajusta o bot√£o para indicar isso
                if (user.plano === 'ESSENTIAL') {
                    const btnEssencial = document.querySelector('#card-plano-essencial .btn-mudar-plano');
                    if (btnEssencial) {
                        // L√ìGICA DE REATIVA√á√ÉO
                        if (user.cancelAtPeriodEnd) {
                            // Modo: Cancelamento Agendado -> Bot√£o vira "Reativar"
                            btnEssencial.textContent = 'Reativar Assinatura ‚Ü∫';
                            btnEssencial.disabled = false;
                            btnEssencial.style.backgroundColor = '#F59E0B'; // Cor de alerta/a√ß√£o
                            btnEssencial.style.borderColor = '#F59E0B';
                            btnEssencial.style.color = '#fff';
                            btnEssencial.style.cursor = 'pointer';
                            
                            // A√ß√£o de Reativar
                            btnEssencial.onclick = async (e) => {
                                e.preventDefault();
                                
                                // 1. Abre o Modal Personalizado (Yelo Style)
                                const modalReativacao = document.getElementById('modal-reativacao');
                                const btnConfirmar = document.getElementById('btn-confirmar-reativacao');
                                const btnFechar = document.getElementById('btn-fechar-modal-reativacao');

                                if (modalReativacao) {
                                    modalReativacao.style.display = 'flex';

                                    // Configura o bot√£o de fechar
                                    btnFechar.onclick = () => modalReativacao.style.display = 'none';

                                    // Configura o bot√£o de confirmar (Clona para remover listeners antigos)
                                    const novoBtnConfirmar = btnConfirmar.cloneNode(true);
                                    btnConfirmar.parentNode.replaceChild(novoBtnConfirmar, btnConfirmar);

                                    novoBtnConfirmar.onclick = async () => {
                                        novoBtnConfirmar.textContent = 'Processando...';
                                        novoBtnConfirmar.disabled = true;

                                        try {
                                            const res = await fetch(`${BASE_URL}/api/psychologists/me/reactivate-subscription`, {
                                                method: 'POST',
                                                headers: { 'Authorization': `Bearer ${token}` }
                                            });
                                            const d = await res.json();

                                            if(res.ok) { 
                                                showToast('Assinatura reativada com sucesso! üöÄ', 'success');
                                                lancarConfetes();
                                                setTimeout(() => window.location.reload(), 1500);
                                            } else { 
                                                // Tratamento do Erro 400 (Assinatura n√£o encontrada/inv√°lida)
                                                console.error("Erro reativa√ß√£o:", d);
                                                
                                                // Se a assinatura n√£o existe mais (400/404), libera para assinar do zero
                                                if (res.status === 400 || res.status === 404 || (d.error && (d.error.includes('encontrada') || d.error.includes('dispon√≠vel')))) {
                                                    showToast('Assinatura anterior expirou. Por favor, realize uma nova assinatura.', 'info');
                                                    modalReativacao.style.display = 'none';
                                                    
                                                    // Transforma o bot√£o de "Reativar" em "Assinar Agora"
                                                    btnEssencial.textContent = 'Assinar Agora üöÄ';
                                                    btnEssencial.style.backgroundColor = '#1B4332';
                                                    btnEssencial.disabled = false;
                                                    
                                                    // Redireciona o clique para abrir o modal de pagamento (Fluxo de Assinatura Expirada)
                                                    btnEssencial.onclick = (evt) => {
                                                        evt.preventDefault();
                                                        abrirModalPagamento('ESSENTIAL');
                                                    };
                                                } else {
                                                    showToast(d.error || 'N√£o foi poss√≠vel reativar. Tente novamente.', 'error');
                                                    setTimeout(() => window.location.reload(), 2000);
                                                }
                                            }
                                        } catch(err) { 
                                            showToast('Erro de conex√£o ao reativar.', 'error');
                                            modalReativacao.style.display = 'none';
                                        }
                                    };
                                }
                            };
                        } else {
                            // Modo: Ativo Normal
                            btnEssencial.textContent = 'Seu Plano Atual';
                            btnEssencial.disabled = true;
                            btnEssencial.style.backgroundColor = '#e0e0e0';
                            btnEssencial.style.borderColor = '#e0e0e0';
                            btnEssencial.style.color = '#888';
                            btnEssencial.style.cursor = 'default';
                        }
                    }
                }
            }

            // --- L√ìGICA PARA PRIMEIRA ASSINATURA (Bot√µes "Quero Come√ßar Agora") ---
            document.querySelectorAll('.btn-upgrade').forEach(btn => {
                btn.onclick = (e) => {
                    e.preventDefault();
                    abrirModalPagamento(btn.getAttribute('data-plano') || 'ESSENTIAL');
                };
            });
        }
    } catch (error) {
        console.error("Erro ao verificar status VIP:", error);
    }

    // --- L√ìGICA DE CANCELAMENTO (ADICIONADO) ---
    const btnCancel = document.getElementById('btn-cancelar-assinatura');
    const modalCancel = document.getElementById('modal-cancelamento');
    const btnCloseModal = document.getElementById('btn-fechar-modal-cancel');
    const btnConfirmCancel = document.getElementById('btn-confirmar-cancelamento');

    // Abrir Modal
    if (btnCancel && modalCancel) {
        btnCancel.onclick = () => modalCancel.style.display = 'flex';
    }
    // Fechar Modal
    if (btnCloseModal && modalCancel) {
        btnCloseModal.onclick = () => modalCancel.style.display = 'none';
    }
    // Confirmar Cancelamento
    if (btnConfirmCancel) {
        btnConfirmCancel.onclick = async () => {
            btnConfirmCancel.disabled = true;
            btnConfirmCancel.textContent = 'Processando...';

            try {
                const res = await fetch(`${BASE_URL}/api/psychologists/me/cancel-subscription`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                if (res.ok) {
                    // Fecha o modal de confirma√ß√£o
                    modalCancel.style.display = 'none';
                    
                    // Abre o modal de sucesso personalizado
                    const modalSuccess = document.getElementById('modal-sucesso-cancelamento');
                    const msgEl = document.getElementById('msg-sucesso-cancelamento');
                    const btnClose = document.getElementById('btn-fechar-sucesso-cancel');
                    
                    if (modalSuccess) {
                        if (msgEl) msgEl.textContent = data.message || 'Assinatura cancelada com sucesso.';
                        modalSuccess.style.display = 'flex';
                        if (btnClose) btnClose.onclick = () => window.location.reload();
                    } else {
                        // Fallback caso o modal n√£o carregue
                        alert(data.message || 'Assinatura cancelada com sucesso.');
                        window.location.reload();
                    }
                } else {
                    // Mesmo com erro, pode ser que o estado tenha mudado.
                    console.error("Erro cancelamento:", data);
                    alert(data.error || 'Houve um problema, mas vamos atualizar a p√°gina para verificar o status.');
                    window.location.reload();
                }
            } catch (err) {
                console.error(err);
                alert('Erro de conex√£o. A p√°gina ser√° recarregada.');
                window.location.reload();
            }
        };
    }

    function aplicarModoVip(planName) {
        // Mapeamento de nomes dos planos para exibi√ß√£o amig√°vel
        const nomesPlanos = {
            'ESSENTIAL': 'Essencial',
            'CLINICAL': 'Cl√≠nico',
            'REFERENCE': 'Refer√™ncia'
        };
        const nomeExibicao = nomesPlanos[planName] || planName || 'Essencial';

        const planNameEl = document.getElementById('vip-plan-name');
        if (planNameEl) planNameEl.textContent = `Plano ${nomeExibicao}`;

        // 1. Esconde a grid de planos (pagamento)
        const planosGrid = document.querySelector('.planos-grid');
        if (planosGrid) planosGrid.style.setProperty('display', 'none', 'important');

        // 2. Esconde √°rea de cancelamento (n√£o faz sentido para isentos)
        const areaCancel = document.getElementById('area-cancelamento');
        if (areaCancel) areaCancel.style.setProperty('display', 'none', 'important');

        // 3. MOSTRA o resumo de assinatura adaptado para VIP
        const resumo = document.getElementById('card-resumo-assinatura');
        if (resumo) {
            resumo.style.display = 'flex'; // Mostra o card
            
            // Atualiza textos para refletir isen√ß√£o
            const nomePlano = document.getElementById('banner-nome-plano');
            if(nomePlano) nomePlano.textContent = `Plano ${nomeExibicao}`;
            
            const preco = document.getElementById('banner-preco');
            if(preco) preco.textContent = 'R$ 0,00 (Isento)';
            
            const renovacao = document.getElementById('banner-renovacao');
            if(renovacao) renovacao.textContent = 'Status: Isento';

            // Estiliza o badge de status
            const badge = resumo.querySelector('.status-badge');
            if(badge) {
                badge.innerHTML = 'üíé VIP Ativo';
                badge.style.backgroundColor = '#e6fffa';
                badge.style.color = '#1B4332';
                badge.style.borderColor = '#1B4332';
            }
        }

        // 4. Mostra o Banner VIP
        const vipBanner = document.getElementById('vip-banner');
        if (vipBanner) vipBanner.style.display = 'block';

        // 5. Ajusta o texto do cabe√ßalho para refletir o status VIP
        const headerTitle = document.querySelector('.main-header h1');
        const headerDesc = document.querySelector('.main-header p');
        if (headerTitle) headerTitle.textContent = 'Sua Assinatura VIP';
        if (headerDesc) headerDesc.textContent = 'Voc√™ possui acesso especial concedido pela Yelo.';
    }

    // Helper para Toasts (Caso n√£o exista globalmente)
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        if (!container) return alert(message); // Fallback

        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        // √çcone baseado no tipo
        const icon = type === 'success' ? '‚úÖ' : '‚ùå';
        toast.innerHTML = `<span>${icon}</span> <span>${message}</span>`;
        
        container.appendChild(toast);
        
        // Anima√ß√£o de entrada
        requestAnimationFrame(() => {
            toast.style.opacity = '1';
            toast.style.transform = 'translateX(0)';
        });

        // Remove ap√≥s 3s
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Fun√ß√£o para efeito de confete (Celebra√ß√£o Yelo)
    function lancarConfetes() {
        if (typeof confetti === 'function') {
            // Dispara uma explos√£o de confetes com as cores da marca
            const count = 200;
            const defaults = {
                origin: { y: 0.7 },
                colors: ['#1B4332', '#FFEE8C', '#2D6A4F', '#F4D35E'] // Verde e Amarelo Yelo
            };

            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }

            fire(0.25, { spread: 26, startVelocity: 55 });
            fire(0.2, { spread: 60 });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45 });
        }
    }

    // Fun√ß√£o auxiliar para abrir o modal de pagamento
    function abrirModalPagamento(plano) {
        const modal = document.getElementById('payment-modal');
        if (modal) {
            modal.style.display = 'flex';
            modal.setAttribute('data-selected-plan', plano); // Salva o plano escolhido no modal
            
            initPaymentModalLogic(); // Garante que os bot√µes funcionem
            
            // Reseta para a tela inicial do modal
            const stepMethod = document.getElementById('step-payment-method');
            const stepForm = document.getElementById('payment-form');
            const pixResult = document.getElementById('pix-result-container');
            if(stepMethod) stepMethod.style.display = 'block';
            if(stepForm) stepForm.style.display = 'none';
            if(pixResult) pixResult.style.display = 'none';
        }
    }

    // --- L√ìGICA DO MODAL DE PAGAMENTO (Corre√ß√£o do Bug) ---
    function initPaymentModalLogic() {
        const modal = document.getElementById('payment-modal');
        if (!modal) return;

        const btnCard = document.getElementById('btn-select-card');
        const btnPix = document.getElementById('btn-select-pix');
        const stepMethod = document.getElementById('step-payment-method');
        const stepForm = document.getElementById('payment-form');
        const pixResult = document.getElementById('pix-result-container');
        const btnBack = document.getElementById('btn-back-method');
        const btnClose = document.getElementById('btn-close-modal-x');
        const btnPagar = document.getElementById('btn-confirmar-stripe'); // Bot√£o de Pagar

        // Fun√ß√£o para resetar o modal ao estado inicial
        const resetModal = () => {
            if(stepMethod) stepMethod.style.display = 'block';
            if(stepForm) stepForm.style.display = 'none';
            if(pixResult) pixResult.style.display = 'none';
        };

        // 1. Fechar Modal
        if(btnClose) btnClose.onclick = () => { 
            modal.style.display = 'none'; 
            resetModal(); 
        };

        // 2. Selecionar Cart√£o
        if(btnCard) btnCard.onclick = () => {
            if(stepMethod) stepMethod.style.display = 'none';
            if(stepForm) stepForm.style.display = 'block';
        };

        // 3. Selecionar PIX
        if(btnPix) btnPix.onclick = () => {
            if(stepMethod) stepMethod.style.display = 'none';
            if(pixResult) pixResult.style.display = 'block';
            // Gera um QR Code de exemplo (ou real do backend)
            const qrImg = document.getElementById('pix-qr-image');
            if(qrImg && !qrImg.src) qrImg.src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=YeloPagamentoPixExemplo';
        };

        // 4. Bot√£o Voltar (dentro do form de cart√£o)
        if(btnBack) btnBack.onclick = () => {
            if(stepForm) stepForm.style.display = 'none';
            if(stepMethod) stepMethod.style.display = 'block';
        };

        // 5. Processar Pagamento (Cart√£o)
        // Removemos listeners antigos para evitar duplica√ß√£o
        const novoBtnPagar = btnPagar.cloneNode(true);
        btnPagar.parentNode.replaceChild(novoBtnPagar, btnPagar);

        novoBtnPagar.onclick = async (e) => {
            e.preventDefault();
            const plano = modal.getAttribute('data-selected-plan') || 'ESSENTIAL';
            
            // Coleta dados do formul√°rio
            const cardData = {
                holderName: document.getElementById('card-holder-name').value,
                holderCpf: document.getElementById('card-holder-cpf').value,
                holderPhone: document.getElementById('card-holder-phone').value,
                number: document.getElementById('card-number').value,
                expiry: document.getElementById('card-expiry').value,
                ccv: document.getElementById('card-ccv').value,
                // Campos de endere√ßo (opcionais ou obrigat√≥rios dependendo da sua regra)
                postalCode: document.getElementById('card-holder-cep').value,
                addressNumber: document.getElementById('card-holder-number').value
            };

            // Valida√ß√£o simples
            if(!cardData.number || !cardData.expiry || !cardData.ccv || !cardData.holderName) {
                alert('Por favor, preencha todos os campos do cart√£o.');
                return;
            }

            novoBtnPagar.textContent = 'Processando...';
            novoBtnPagar.disabled = true;

            try {
                const res = await fetch(`${(typeof window.API_BASE_URL !== 'undefined') ? window.API_BASE_URL : 'http://localhost:3001'}/api/payments/create-preference`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('Yelo_token')}` 
                    },
                    body: JSON.stringify({ planType: plano, billingType: 'CREDIT_CARD', creditCard: cardData })
                });
                const data = await res.json();

                if(res.ok) {
                    showToast('Pagamento aprovado! Bem-vindo(a) √† Yelo! üöÄ', 'success');
                    lancarConfetes();
                    setTimeout(() => window.location.reload(), 2000);
                } else {
                    alert(data.error || 'Erro ao processar pagamento.');
                    novoBtnPagar.textContent = 'Pagar Agora';
                    novoBtnPagar.disabled = false;
                }
            } catch(err) {
                alert('Erro de conex√£o.');
                novoBtnPagar.textContent = 'Pagar Agora';
                novoBtnPagar.disabled = false;
            }
        };
    }

    // Inicializa a l√≥gica assim que a p√°gina carrega
    initPaymentModalLogic();
})();
</script>