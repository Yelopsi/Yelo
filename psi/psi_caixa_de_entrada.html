<!-- psi_caixa_de_entrada.html -->
<!-- ESTRUTURA REFEITA DO ZERO PARA ISOLAMENTO DE LAYOUT -->

<style>
    /* --- CSS IMPORTADO E ADAPTADO DO ADMIN (ESTILO WHATSAPP WEB) --- */
    
    /* --- SCROLLBAR MODERNA --- */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #aaa; }

    /* --- LAYOUT PRINCIPAL --- */
    .chat-layout {
        display: flex;
        height: calc(100vh - 140px); /* Aumentado espa√ßo vertical */
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.08);
        border: 1px solid #f0f0f0;
        overflow: hidden;
        font-family: var(--font-principal);
        margin-top: 10px;
        position: relative;
        z-index: 1;
    }

    /* --- Lado Esquerdo: Lista --- */
    .chat-list-panel {
        width: 360px;
        border-right: 1px solid #f0f0f0;
        display: flex;
        flex-direction: column;
        flex-shrink: 0;
        background: #fff; 
        position: relative; 
        z-index: 5; 
    }

    .search-and-filter-bar {
        padding: 15px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 10px; 
    }

    .search-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        width: 100%;
    }

    .search-wrapper i {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
        font-size: 0.9rem;
        pointer-events: none;
        z-index: 10;
    }

    #chat-search {
        width: 100%;
        padding: 12px 10px 12px 35px;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 8px;
        outline: none;
        font-size: 0.9rem;
        color: #333;
    }

    .conversations-list {
        flex: 1;
        overflow-y: auto;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    /* Item da Lista */
    .conversation-item {
        display: flex;
        align-items: center;
        padding: 15px;
        margin: 4px 8px;
        border-radius: 10px;
        cursor: pointer;
        border-bottom: none;
        transition: background 0.2s;
    }
    .conversation-item:hover { background: #f5f7f6; }
    .conversation-item.active { background: #e8f5e9; }
    
    .conversation-item .avatar, .avatar-img {
        width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 12px;
        flex-shrink: 0;
    }
    .conversation-details {
        flex: 1;
        min-width: 0;
        overflow: hidden;
    }
    .contact-name, .conv-name { font-weight: 600; color: #333; font-size: 0.95rem; transition: color 0.2s; display: block; }
    .conversation-item.active .contact-name { color: #1B4332; }

    .last-message-line {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .last-message, .conv-preview { font-size: 0.85rem; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

    /* --- Lado Direito: Chat Ativo --- */
    .chat-view-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
        min-width: 0;
        height: 100%;
    }

    /* Header do Chat */
    .chat-panel-header {
        height: 70px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        padding: 0 20px;
        border-bottom: 1px solid #f0f0f0;
        background: #fff;
    }
    .chat-panel-header .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 15px; }
    .contact-info h4 { margin: 0; font-size: 1rem; color: #1B4332; font-weight: 700; }
    .contact-info span { font-size: 0.8rem; color: #888; }

    /* Wrapper da Conversa */
    .active-chat-wrapper {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    /* √Årea de Mensagens */
    .messages-thread, .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #e5ddd5;
        background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAICAYAAADR7oBbAAAAFUlEQVQYV2NkgID/Generalized/4wZTAwMjAIAwAAtgAt44yFNgAAAABJRU5ErkJggg==');
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Bal√µes (Compatibilidade com classes antigas e novas) */
    .message-bubble, .msg-bubble {
        max-width: 70%;
        width: fit-content;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.75rem; /* Fonte reduzida em ~50% da escala visual */
        line-height: 1.3;
        position: relative;
        box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        display: flex;
        align-items: flex-end;
        gap: 10px;
    }

    .message-bubble p, .msg-bubble p {
        margin: 0;
        padding: 0;
        word-break: break-word;
    }

    .message-bubble.sent, .msg-sent {
        align-self: flex-end;
        background-color: #1B4332; /* Verde Yelo */
        color: #fff;
        border-bottom-right-radius: 4px;
    }

    .message-bubble.sent .message-meta, .msg-sent .msg-meta {
        color: rgba(255,255,255,0.7);
    }
    .message-bubble.sent .message-status svg {
        stroke: rgba(255,255,255,0.8) !important;
    }

    .message-bubble.received, .msg-received {
        align-self: flex-start;
        background-color: #fff;
        color: #111;
        border-bottom-left-radius: 4px;
        border: 1px solid #f0f0f0;
    }

    .message-meta, .msg-meta {
        flex-shrink: 0;
        white-space: nowrap;
        font-size: 0.7rem;
        color: #999;
        align-self: flex-end;
    }

    /* Rodap√© de Input */
    .message-input-bar, .input-area {
        padding: 15px 20px;
        background: #fff;
        border-top: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }

    #psi-reply-input {
        background-color: #f0f2f5;
        border: 1px solid transparent;
        border-radius: 24px;
        padding: 12px 20px;
        transition: all 0.2s;
        flex-grow: 1;
        outline: none;
    }

    #psi-reply-input:focus {
        background-color: #fff;
        border-color: #1B4332;
        box-shadow: 0 0 0 3px rgba(27, 67, 50, 0.1);
    }

    .btn-send, #send-reply-btn {
        width: 45px; height: 45px;
        border-radius: 50%;
        background: #1B4332;
        color: #fff;
        border: none;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
    }
    .btn-send:hover, #send-reply-btn:hover { transform: scale(1.05); }

    /* Telas de Estado */
    .chat-welcome-view, .welcome-screen {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 100%; text-align: center; color: #888; padding: 20px;
    }
    .chat-welcome-view svg, .welcome-screen svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.2; }

    /* Responsividade */
    @media (max-width: 992px) {
        
        /* 1. Oculta o t√≠tulo padr√£o "Mensagens" para limpar a tela */
        .main-header { display: none !important; }

        /* 2. O Container Principal (Travado entre o Header e o Menu) */
        .chat-layout {
            position: fixed !important;
            
            /* Ajuste Fino: Altura do seu Header 'yelo + MENU' */
            /* Se o seu header for maior/menor, ajuste os 60px abaixo */
            top: 60px !important; 
            
            /* Ajuste Fino: Altura da sua Bottom Nav (√≠cones inferiores) */
            /* Isso garante que o input fique EXATAMENTE acima do menu */
            bottom: 80px !important; 
            
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            height: auto !important; /* Deixa o top/bottom definirem a altura */
            
            margin: 0 !important;
            border: none;
            border-radius: 0;
            box-shadow: none;
            background: #e5ddd5; /* Fundo bege para evitar buracos brancos */
            z-index: 900;
            
            display: flex !important;
            flex-direction: column !important;
        }

        /* 3. Painel de Visualiza√ß√£o (Preenche o container) */
        .chat-view-panel {
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
            height: 100% !important;
            position: static !important;
        }

        /* Esconde a lista de contatos quando o chat est√° aberto */
        .chat-layout.mobile-chat-active .chat-list-panel { display: none !important; }
        /* Garante que o painel apare√ßa */
        .chat-layout.mobile-chat-active .chat-view-panel { display: flex !important; }

        /* 4. Header INTERNO do Chat (Avatar, Nome, Voltar) */
        .chat-panel-header {
            flex-shrink: 0; /* Impede de ser esmagado */
            height: 60px;
            background: #fff; /* Ou a cor que preferir */
            border-bottom: 1px solid #ddd;
            display: flex;
            align-items: center;
            padding: 0 10px;
            z-index: 10;
        }

        /* 5. √Årea de Mensagens (Onde ocorre o scroll) */
        .messages-thread {
            flex-grow: 1 !important; /* Estica para ocupar todo o espa√ßo livre */
            height: 0 !important; /* Hack vital para scroll flexbox */
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            padding-bottom: 20px;
            background-color: #e5ddd5; 
        }

        /* 6. Barra de Input (Rodap√© do Chat) */
        .message-input-bar {
            flex-shrink: 0; /* Nunca encolhe */
            padding: 10px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* Bot√£o Voltar (aparece s√≥ no mobile) */
        #btn-voltar-mobile { 
            display: inline-flex !important;
            margin-right: 5px; 
            border: none; 
            background: transparent; 
            padding: 5px;
            color: #1B4332;
        }
    }
</style>

<!-- Cabe√ßalho (Apenas Desktop) -->
<div class="main-header">
    <div>
        <h1>Mensagens</h1>
        <p class="subtitulo-header">Fale com o suporte da Yelo.</p>
    </div>
</div>

<div class="chat-layout" id="chat-interface-wrapper">
    <!-- LADO ESQUERDO: LISTA -->
    <div class="chat-list-panel">
        <div class="search-and-filter-bar">
            <div class="search-wrapper">
                <i>üîç</i>
                <input type="text" id="chat-search" placeholder="Buscar conversa...">
            </div>
        </div>
        
        <ul id="conversation-list" class="conversations-list">
            <!-- Injetado via JS -->
            <li class="conversation-item active" id="btn-open-support-chat">
                <img src="/assets/logos/logo-escura.png" alt="Avatar" class="avatar" style="background:#f0f0f0; padding:5px; object-fit: contain;">
                <div class="conversation-details">
                    <div class="details-header">
                        <span class="contact-name">Suporte Yelo</span>
                        <span class="timestamp">Agora</span>
                    </div>
                    <div class="last-message-line">
                        <p class="last-message">Canal de suporte direto</p>
                        <span class="unread-badge hidden">0</span>
                    </div>
                </div>
            </li>
        </ul>
    </div>

    <!-- LADO DIREITO: CHAT -->
    <div class="chat-view-panel">
        
        <!-- Tela de Boas Vindas (Vazia) -->
        <div id="chat-welcome-screen" class="chat-welcome-view">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
            <h3>Selecione uma conversa</h3>
            <p>Escolha um contato √† esquerda para iniciar o atendimento.</p>
        </div>

        <!-- Tela de Chat Ativo -->
        <div id="active-chat-screen" class="active-chat-wrapper" style="display: none;">
            
            <div class="chat-panel-header">
                <button id="btn-voltar-mobile" class="back-to-list-btn" style="display: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>
                </button>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="/assets/logos/logo-escura.png" alt="Avatar" class="avatar" style="border: 1px solid #eee; object-fit: contain; padding: 5px; background-color: #f9f9f9;">
                    <div class="contact-info">
                        <h4 style="display: flex; align-items: center; gap: 5px;">Suporte Yelo <svg width="16" height="16" viewBox="0 0 24 24" fill="#1da1f2" xmlns="http://www.w3.org/2000/svg"><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.154-.435.238-.905.238-1.4 0-2.21-1.71-3.998-3.818-3.998-.47 0-.92.084-1.336.25C14.818 2.415 13.51 1.5 12 1.5s-2.816.917-3.437 2.25c-.415-.165-.866-.25-1.336-.25-2.11 0-3.818 1.79-3.818 4 0 .495.083.965.238 1.4-1.272.65-2.147 2.018-2.147 3.6 0 1.495.782 2.798 1.942 3.486-.02.17-.032.34-.032.514 0 2.21 1.708 4 3.818 4 .47 0 .92-.086 1.335-.25.62 1.334 1.926 2.25 3.437 2.25 1.512 0 2.818-.916 3.437-2.25.415.163.865.248 1.336.248 2.11 0 3.818-1.79 3.818-4 0-.174-.012-.344-.033-.513 1.158-.687 1.943-1.99 1.943-3.484zm-6.616-3.334l-4.334 6.5c-.145.217-.382.334-.625.334-.143 0-.288-.04-.416-.126l-.115-.094-2.415-2.415c-.293-.293-.293-.768 0-1.06s.768-.294 1.06 0l1.77 1.767 3.825-5.74c.23-.345.696-.436 1.04-.207.346.23.44.696.21 1.04z"/></svg></h4>
                        <span>Canal Oficial</span>
                    </div>
                </div>
            </div>

            <div id="messages-thread" class="messages-thread">
                <!-- Mensagens injetadas via JS -->
            </div>

            <div class="message-input-bar">
                <input type="text" id="psi-reply-input" placeholder="Digite sua mensagem...">
                <button id="send-reply-btn" class="btn-send">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                </button>
            </div>

        </div>

    </div>
</div>

<script>
    // Script Inline para garantir funcionamento imediato da UI
    (function() {
        const wrapper = document.getElementById('chat-interface-wrapper');
        const btnVoltar = document.getElementById('btn-voltar-mobile');
        const list = document.getElementById('conversation-list');
        const welcome = document.getElementById('chat-welcome-screen');
        const active = document.getElementById('active-chat-screen');

        // Auto-open chat on mobile
        if (window.innerWidth <= 992) {
            wrapper.classList.add('mobile-chat-active');
            if(welcome) welcome.style.display = 'none';
            if(active) active.style.display = 'flex';
        }

        // Fun√ß√£o para abrir chat (Mobile)
        window.abrirChatMobile = function() {
            if (window.innerWidth <= 992) {
                wrapper.classList.add('mobile-chat-active');
            }
            if(welcome) welcome.style.display = 'none';
            
            // IMPORTANTE: Tem que ser FLEX para o layout vertical funcionar
            if(active) active.style.display = 'flex'; 
            
            // (Opcional) For√ßa o scroll para o fim ao abrir
            const thread = document.getElementById('messages-thread');
            if(thread) setTimeout(() => { thread.scrollTop = thread.scrollHeight; }, 50);
        };

        // Fun√ß√£o para fechar chat (Mobile)
        if (btnVoltar) {
            btnVoltar.addEventListener('click', function() {
                wrapper.classList.remove('mobile-chat-active');
            });
        }

        // Delega√ß√£o de eventos para a lista (j√° que os itens s√£o din√¢micos)
        if (list) {
            list.addEventListener('click', function(e) {
                const item = e.target.closest('.conversation-item');
                if (item) {
                    // Remove ativo anterior
                    document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    window.abrirChatMobile();
                }
            });
        }
    })();
</script>
