<!-- psi_caixa_de_entrada.html -->
<!-- ESTRUTURA REFEITA DO ZERO PARA ISOLAMENTO DE LAYOUT -->

<style>
    /* --- CSS ESPECÍFICO E ISOLADO PARA O CHAT --- */
    
    /* 1. Container Raiz (Desktop) */
    #chat-root-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 140px); /* Altura calculada para Desktop */
        background-color: #fff;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.05);
        border: 1px solid #e0e0e0;
        overflow: hidden;
        font-family: 'Inter', sans-serif;
        position: relative;
    }

    /* 2. Header da Página (Desktop) */
    .chat-page-header {
        padding: 20px 25px;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #fff;
    }
    .chat-page-header h1 { margin: 0; font-size: 1.5rem; color: #1B4332; font-family: 'New Kansas', sans-serif; }
    .chat-page-header p { margin: 5px 0 0 0; color: #666; font-size: 0.9rem; }

    /* 3. Layout Interno (Lista + Conversa) */
    .chat-interface {
        display: flex;
        flex: 1; /* Ocupa o resto da altura */
        overflow: hidden; /* Impede rolagem externa */
    }

    /* Painel Esquerdo (Lista) */
    .chat-sidebar {
        width: 320px;
        border-right: 1px solid #f0f0f0;
        display: flex;
        flex-direction: column;
        background: #fcfcfc;
    }

    /* Painel Direito (Conversa) */
    .chat-main-view {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: #fff;
        position: relative;
    }

    /* --- Componentes Internos --- */
    
    /* Lista de Conversas */
    .conversation-list {
        list-style: none;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        flex: 1;
    }
    .conversation-item {
        display: flex;
        align-items: center;
        padding: 15px 20px;
        cursor: pointer;
        border-bottom: 1px solid #f5f5f5;
        transition: background 0.2s;
    }
    .conversation-item:hover { background-color: #f0fdf4; }
    .conversation-item.active { background-color: #e8f5e9; border-left: 4px solid #1B4332; }
    
    .avatar-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 1px solid #eee; }
    .conv-info { flex: 1; overflow: hidden; }
    .conv-name { font-weight: 600; color: #333; font-size: 0.95rem; display: block; }
    .conv-preview { font-size: 0.85rem; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

    /* Área de Mensagens */
    .messages-area {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #f8f9fa;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    /* Balões */
    .msg-bubble {
        max-width: 75%;
        padding: 10px 15px;
        border-radius: 12px;
        font-size: 0.95rem;
        line-height: 1.5;
        position: relative;
        word-wrap: break-word;
    }
    .msg-received {
        align-self: flex-start;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-bottom-left-radius: 2px;
    }
    .msg-sent {
        align-self: flex-end;
        background: #1B4332;
        color: #fff;
        border-bottom-right-radius: 2px;
    }
    .msg-meta {
        font-size: 0.7rem;
        margin-top: 5px;
        text-align: right;
        opacity: 0.7;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        gap: 4px;
    }

    /* Barra de Input */
    .input-area {
        padding: 15px 20px;
        background: #fff;
        border-top: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #psi-reply-input {
        flex: 1;
        padding: 12px 15px;
        border-radius: 24px;
        border: 1px solid #ddd;
        background: #f9f9f9;
        font-size: 1rem;
        outline: none;
    }
    #psi-reply-input:focus { border-color: #1B4332; background: #fff; }
    
    #send-reply-btn {
        width: 45px; height: 45px;
        border-radius: 50%;
        background: #1B4332;
        color: #fff;
        border: none;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: transform 0.2s;
    }
    #send-reply-btn:hover { transform: scale(1.05); }

    /* Header do Chat Ativo */
    .active-chat-header {
        padding: 10px 20px;
        background: #fff;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        height: 60px;
        flex-shrink: 0;
    }
    .btn-back-mobile { display: none; margin-right: 10px; background: none; border: none; cursor: pointer; color: #1B4332; }

    /* Telas de Estado */
    .welcome-screen {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 100%; text-align: center; color: #888; padding: 20px;
    }
    .welcome-screen svg { width: 80px; height: 80px; margin-bottom: 20px; opacity: 0.2; }

    /* ==========================================================================
       4. AJUSTES CRÍTICOS PARA MOBILE (FIXED VIEWPORT)
       ========================================================================== */
    @media (max-width: 992px) {
        /* Esconde o cabeçalho da página para ganhar espaço */
        .chat-page-header { display: none !important; }

        /* O Container Raiz vira uma camada FIXA sobre o dashboard */
        #chat-root-container {
            position: fixed !important;
            top: 75px !important;    /* Abaixo do Header Mobile (~60-75px) */
            bottom: 90px !important; /* Acima da Bottom Nav (~80-90px) */
            left: 0 !important;
            right: 0 !important;
            width: 100% !important;
            height: auto !important; /* Respeita top/bottom */
            margin: 0 !important;
            border-radius: 0 !important;
            border: none !important;
            z-index: 900; /* Acima do conteúdo, abaixo de modais/menus */
        }

        /* Ajuste da Sidebar (Lista) */
        .chat-sidebar {
            width: 100%;
            height: 100%;
            display: flex; /* Mostra por padrão */
        }

        /* Ajuste do Chat Ativo (Escondido por padrão) */
        .chat-main-view {
            display: none; /* Esconde inicialmente */
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
        }

        /* Classe para mostrar o chat ativo */
        .chat-interface.mobile-chat-open .chat-sidebar { display: none; }
        .chat-interface.mobile-chat-open .chat-main-view { display: flex; }

        /* Botão Voltar */
        .btn-back-mobile { display: block; }
        
        /* Ajuste do Input para Mobile */
        .input-area { padding: 10px; }
        #psi-reply-input { font-size: 16px; } /* Evita zoom no iOS */
    }

    /* --- CORREÇÃO DE IMAGENS/AVATARES --- */
    .chat-avatar-fixed {
        width: 40px !important;
        height: 40px !important;
        border-radius: 50%;
        object-fit: contain; /* Garante que a logo não distorça */
        background-color: #f9f9f9;
        border: 1px solid #eee;
        flex-shrink: 0;
    }
</style>

<div id="chat-root-container">
    <!-- Cabeçalho (Apenas Desktop) -->
    <div class="chat-page-header">
        <div>
            <h1>Mensagens</h1>
            <p>Fale com o suporte ou com seus pacientes.</p>
        </div>
    </div>

    <div class="chat-interface" id="chat-interface-wrapper">
        
        <!-- LADO ESQUERDO: LISTA -->
        <aside class="chat-sidebar">
            <div style="padding: 15px; border-bottom: 1px solid #f0f0f0;">
                <input type="text" placeholder="Buscar conversa..." style="width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px; background: #f9f9f9;">
            </div>
            
            <ul id="conversation-list" class="conversation-list">
                <!-- Injetado via JS -->
                <li style="padding: 20px; text-align: center; color: #999;">Carregando...</li>
            </ul>
        </aside>

        <!-- LADO DIREITO: CHAT -->
        <main class="chat-main-view">
            
            <!-- Tela de Boas Vindas (Vazia) -->
            <div id="chat-welcome-screen" class="welcome-screen">
                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/></svg>
                <h3>Selecione uma conversa</h3>
                <p>Escolha um contato à esquerda para iniciar o atendimento.</p>
            </div>

            <!-- Tela de Chat Ativo -->
            <div id="active-chat-screen" style="display: none; flex-direction: column; height: 100%;">
                
                <div class="active-chat-header">
                    <button id="btn-voltar-mobile" class="btn-back-mobile">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    </button>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <img src="/assets/logos/logo-escura.png" alt="Avatar" class="chat-avatar-fixed">
                        <div>
                            <strong style="display: block; line-height: 1.2; color: #1B4332;">Suporte Yelo</strong>
                            <span style="font-size: 0.75rem; color: #888;">Canal Oficial</span>
                        </div>
                    </div>
                </div>

                <div id="messages-thread" class="messages-area">
                    <!-- Mensagens injetadas via JS -->
                </div>

                <div class="input-area">
                    <input type="text" id="psi-reply-input" placeholder="Digite sua mensagem...">
                    <button id="send-reply-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg>
                    </button>
                </div>

            </div>

        </main>
    </div>
</div>

<script>
    // Script Inline para garantir funcionamento imediato da UI
    // A lógica pesada (Socket.IO, Fetch) continua no arquivo psi_caixa_de_entrada.js
    // Este script apenas gerencia a troca de telas no mobile para garantir a UX
    
    (function() {
        const wrapper = document.getElementById('chat-interface-wrapper');
        const btnVoltar = document.getElementById('btn-voltar-mobile');
        const list = document.getElementById('conversation-list');
        const welcome = document.getElementById('chat-welcome-screen');
        const active = document.getElementById('active-chat-screen');

        // Função para abrir chat (Mobile)
        window.abrirChatMobile = function() {
            if (window.innerWidth <= 992) {
                wrapper.classList.add('mobile-chat-open');
            }
            welcome.style.display = 'none';
            active.style.display = 'flex';
        };

        // Função para fechar chat (Mobile)
        if (btnVoltar) {
            btnVoltar.addEventListener('click', function() {
                wrapper.classList.remove('mobile-chat-open');
                // Opcional: Limpar chat ativo ou manter estado
            });
        }

        // Delegação de eventos para a lista (já que os itens são dinâmicos)
        if (list) {
            list.addEventListener('click', function(e) {
                const item = e.target.closest('.conversation-item');
                if (item) {
                    // Remove ativo anterior
                    document.querySelectorAll('.conversation-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    window.abrirChatMobile();
                }
            });
        }
    })();
</script>
