<style>
    /* --- FullCalendar Customization (Melhoria de UX/Leitura) --- */
    .fc-header-toolbar {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 20px !important;
        flex-wrap: wrap;
        gap: 10px;
    }

    .fc-toolbar-title {
        font-family: var(--font-titulos) !important;
        font-size: 1.4rem !important;
        color: var(--verde-escuro);
        font-weight: 600;
    }

    .fc-button {
        background-color: #fff !important;
        border: 1px solid #e0e0e0 !important;
        color: #555 !important;
        font-weight: 500 !important;
        border-radius: 8px !important;
        padding: 8px 16px !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02) !important;
        transition: all 0.2s ease !important;
        text-transform: capitalize !important;
    }

    .fc-button:hover {
        background-color: #f9f9f9 !important;
        border-color: #ccc !important;
        color: #333 !important;
        transform: translateY(-1px);
    }

    .fc-button-active {
        background-color: var(--verde-escuro) !important;
        border-color: var(--verde-escuro) !important;
        color: #fff !important;
    }
    
    .fc-button-group > .fc-button {
        margin: 0 2px !important; /* Pequeno espa√ßo entre bot√µes agrupados */
    }

    /* Alinhamento do Header da Carteira de Pacientes */
    .widget-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .widget-header-row h3 {
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
    }
    
    .badge-count {
        background-color: #e8f5e9;
        color: var(--verde-escuro);
        font-weight: bold;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        border: 1px solid #cce5d4;
    }

    .patient-status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: capitalize;
        margin-left: auto; /* Empurra para a direita */
        margin-right: 10px; /* Espa√ßo antes do pr√≥ximo √≠cone */
    }
    .status-ativo { background-color: #e8f5e9; color: #1B4332; }
    .status-inativo { background-color: #f1f3f5; color: #6c757d; }

    /* --- Custom Select (Yelo Aesthetic) --- */
    .custom-select-wrapper {
        position: relative;
        width: 150px; /* Largura ajust√°vel */
    }

    .custom-select-trigger {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        border-radius: 20px;
        border: 1px solid #eee;
        background-color: #f9fafb;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    .custom-select-wrapper:hover .custom-select-trigger {
        border-color: var(--verde-escuro);
    }

    .custom-select-arrow { transition: transform 0.3s ease; }
    .custom-select-wrapper.open .custom-select-arrow { transform: rotate(180deg); }

    .custom-select-options {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        width: 100%;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        z-index: 10;
        overflow: hidden;
        display: none;
        animation: fadeIn 0.2s;
    }
    .custom-select-wrapper.open .custom-select-options { display: block; }
    .custom-option { padding: 12px 15px; cursor: pointer; transition: background-color 0.2s; }
    .custom-option:hover { background-color: #f0fdf4; color: var(--verde-escuro); }
    .custom-option.selected { background-color: var(--verde-escuro); color: #fff; font-weight: 600; }

    /* --- Next Sessions Widget --- */
    .next-session-card {
        min-width: 220px;
        background: #f9fafb;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 12px 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
        cursor: pointer;
    }
    .next-session-card:hover {
        transform: translateY(-2px);
        border-color: var(--verde-escuro);
        background: #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .ns-time {
        background: #e8f5e9;
        color: #1B4332;
        padding: 6px 10px;
        border-radius: 8px;
        font-weight: 800;
        font-size: 0.9rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        line-height: 1.1;
    }
    .ns-info { flex-grow: 1; overflow: hidden; }
    .ns-info h5 { margin: 0; font-size: 0.95rem; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ns-info span { font-size: 0.8rem; color: #666; }

    /* --- Layout Responsivo (Corre√ß√£o Mobile) --- */
    .patients-layout-grid {
        display: grid;
        grid-template-columns: 350px 1fr;
        gap: 25px;
        height: calc(100vh - 180px);
    }

    @media (max-width: 992px) {
        .patients-layout-grid {
            display: flex;
            flex-direction: column;
            height: auto;
        }
        
        .patient-controls-row {
            flex-direction: column;
            align-items: stretch !important;
        }
        
        .custom-select-wrapper {
            width: 100%;
        }
    }
</style>

<div class="main-header">
    <div class="header-content">
        <h1>Meus Pacientes</h1>
        <p>Gerencie seus atendimentos e sua agenda.</p>
    </div>
    <div class="dashboard-header-actions header-action-desktop">
        <button id="btn-add-patient" class="btn" style="background-color: #fff; color: #1B4332; display: flex; align-items: center; gap: 8px; border: 1px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <span style="font-size: 1.2rem; line-height: 0;">+</span> Novo Paciente
        </button>
    </div>
</div>

    <div class="patients-layout-grid">
    
    <!-- COLUNA 1: LISTA DE PACIENTES -->
    <div class="widget" style="display: flex; flex-direction: column; height: 100%;">
        <div class="widget-header-row">
            <h3 class="widget-title">Carteira de Pacientes</h3>
            <span class="badge-count" id="patient-count">0</span>
        </div>

        <div class="patient-controls-row" style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
            <div class="search-wrapper" style="flex-grow: 1; margin-bottom: 0;">
                <input type="text" id="search-patient" placeholder="Buscar por nome..." class="form-control" style="width: 100%; box-sizing: border-box; border-radius: 20px; padding: 12px 20px; border: 1px solid #eee; background-color: #f9fafb;">
            </div>
            <div class="custom-select-wrapper" style="flex-shrink: 0;">
                <div class="custom-select-trigger" id="status-filter-trigger">
                    <span id="status-filter-selected-text">Ativos</span>
                    <span class="custom-select-arrow">‚ñº</span>
                </div>
                <div class="custom-select-options" id="status-filter-options">
                    <div class="custom-option selected" data-value="ativo">Ativos</div>
                    <div class="custom-option" data-value="inativo">Inativos</div>
                    <div class="custom-option" data-value="todos">Todos</div>
                </div>
                <input type="hidden" id="filter-patient-status" value="ativo">
            </div>
        </div>

        <div class="patient-list-container" id="patient-list">
            <!-- Lista renderizada via JS -->
            <div class="empty-state-patients">
                <p>Nenhum paciente cadastrado.</p>
            </div>
        </div>
    </div>

    <!-- COLUNA 2: CALEND√ÅRIO -->
    <div class="widget">
        <!-- PR√ìXIMAS SESS√ïES -->
        <div id="next-sessions-container" style="margin-bottom: 25px; display: none;">
            <h4 style="margin: 0 0 15px 0; color: #1B4332; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                <span style="background:#e8f5e9; padding:4px; border-radius:50%;">‚ö°</span> Pr√≥ximos Atendimentos
            </h4>
            <div id="next-sessions-list" style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: thin;"></div>
        </div>

        <div class="widget-header-row">
            <h3 class="widget-title">Agenda</h3>
            <div class="calendar-legend">
                <span class="legend-item"><span class="dot" style="background-color: #3788d8;"></span> Agendado</span>
                <span class="legend-item"><span class="dot" style="background-color: #1B4332;"></span> Confirmado</span>
                <span class="legend-item"><span class="dot" style="background-color: #FFC107;"></span> Dispon√≠vel</span>
                <span class="legend-item"><span class="dot" style="background-color: #9e9e9e;"></span> Realizado</span>
                <span class="legend-item"><span class="dot" style="background-color: #d32f2f;"></span> Falta</span>
            </div>
        </div>
        <div id="calendar-wrapper" style="flex-grow: 1;"></div>
    </div>
</div>

<!-- FAB MOBILE: NOVO PACIENTE -->
<button id="btn-add-patient-mobile" class="mobile-fab" title="Novo Paciente">+</button>

<!-- MODAL: ADICIONAR/EDITAR PACIENTE -->
<div id="modal-patient" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box">
        <button class="modal-close-btn" id="close-patient-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <h3 id="modal-patient-title" style="margin-top: 0; color: #1B4332;">Novo Paciente</h3>
        
        <form id="form-patient">
            <input type="hidden" id="p-id"> <!-- ID oculto para edi√ß√£o -->
            <div class="form-group">
                <label>Nome Completo *</label>
                <input type="text" id="p-name" required placeholder="Ex: Jo√£o Silva">
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>WhatsApp *</label>
                    <input type="tel" id="p-phone" required placeholder="(00) 00000-0000">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>E-mail (Opcional)</label>
                    <input type="email" id="p-email" placeholder="joao@email.com">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Valor da Sess√£o (R$)</label>
                    <input type="number" id="p-session-value" placeholder="0,00" step="0.01" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Status do Paciente</label>
                    <select id="p-status" required class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background-color: #f9fafb;">
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                    </select>
                </div>
            </div>

            <div class="form-group highlight-box assistant-card" style="margin-top: 15px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div class="assistant-icon">ü§ñ</div>
                    <div>
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <label for="p-automated-msg" style="font-weight: bold; color: #1B4332; cursor: pointer; font-size: 1rem;">Ativar Assistente Pessoal</label>
                            <label class="switch-toggle">
                                <input type="checkbox" id="p-automated-msg" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p style="font-size: 0.85rem; color: #555; margin: 8px 0 0 0; line-height: 1.4;">
                            Enviaremos lembretes autom√°ticos de sess√£o e confirma√ß√£o de hor√°rio via WhatsApp.
                        </p>
                    </div>
                </div>
            </div>

            <div class="form-actions" style="justify-content: space-between; margin-top: 25px; display: flex; align-items: center;">
                <!-- Bot√£o de Excluir (S√≥ aparece na edi√ß√£o) -->
                <button type="button" id="btn-delete-patient" style="display: none; background: none; border: none; color: #d32f2f; cursor: pointer; padding: 8px; border-radius: 50%; transition: background 0.2s;" title="Excluir Paciente">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>
                
                <!-- Bot√£o Simular Lembrete -->
                <button type="button" id="btn-simulate-reminder" style="display: none; background: #e3f2fd; color: #0277bd; border: 1px solid #b3e5fc; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; cursor: pointer; margin-right: auto; margin-left: 10px;">
                    üîî Simular Lembrete
                </button>

                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button type="button" class="btn btn-secundario" id="cancel-patient-modal">Cancelar</button>
                    <button type="submit" class="btn btn-principal">Salvar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: AGENDAMENTO (NOVO) -->
<div id="modal-appointment" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box">
        <button class="modal-close-btn" id="close-appointment-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <h3 id="modal-appointment-title" style="margin-top: 0; color: #1B4332;">Novo Agendamento</h3>
        
        <form id="form-appointment">
            <div class="form-group">
                <label>Tipo de Evento</label>
                <select id="appt-type" class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background-color: #fff; margin-bottom: 15px;">
                    <option value="session">Sess√£o com Paciente</option>
                    <option value="available">Hor√°rio Dispon√≠vel</option>
                </select>
            </div>

            <div class="form-group" id="group-patient-select">
                <label>Paciente *</label>
                <select id="appt-patient" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background-color: #f9fafb;">
                    <option value="">Selecione...</option>
                    <!-- Preenchido via JS -->
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Data</label>
                    <input type="date" id="appt-date" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Hor√°rio</label>
                    <input type="time" id="appt-time" required step="300" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;">
                </div>
            </div>

            <div class="form-group highlight-box assistant-card" style="margin-top: 15px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div class="assistant-icon">üîÅ</div>
                    <div style="flex-grow: 1;">
                        <label for="appt-recurrence" style="font-weight: bold; color: #1B4332; display: block; margin-bottom: 8px;">Frequ√™ncia</label>
                        <select id="appt-recurrence" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; background-color: #fff;">
                            <option value="none">N√£o repetir (Sess√£o √önica)</option>
                            <option value="weekly">Semanalmente</option>
                            <option value="biweekly">Quinzenalmente</option>
                        </select>
                        <p style="font-size: 0.85rem; color: #555; margin: 8px 0 0 0; line-height: 1.4;">
                            Define se o agendamento se repetir√° automaticamente.
                        </p>
                    </div>
                </div>
            </div>

            <div class="form-actions" style="justify-content: flex-end; margin-top: 25px; display: flex; gap: 10px;">
                <button type="button" class="btn btn-secundario" id="cancel-appointment-modal">Cancelar</button>
                <button type="submit" class="btn btn-principal">Agendar</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: CONFIRMAR EXCLUS√ÉO (YELO STYLE) -->
<div id="modal-delete-confirmation" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box" style="text-align: center; max-width: 400px;">
        <div style="margin-bottom: 20px; color: #e63946;">
            <svg xmlns="http://www.w3.org/2000/svg" width="50" height="50" fill="currentColor" viewBox="0 0 16 16">
                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
            </svg>
        </div>
        <h3 style="margin-bottom: 10px; color: #333;">Excluir Paciente?</h3>
        <p style="color: #666; margin-bottom: 25px; line-height: 1.5;">
            Tem certeza que deseja remover este paciente? Essa a√ß√£o n√£o pode ser desfeita.
        </p>
        <div style="display: flex; gap: 10px; justify-content: center;">
            <button id="btn-cancel-delete" style="padding: 10px 20px; border: 1px solid #ddd; background: #fff; border-radius: 6px; cursor: pointer; color: #555; font-weight: 600;">Cancelar</button>
            <button id="btn-confirm-delete" style="padding: 10px 20px; border: none; background: #e63946; border-radius: 6px; cursor: pointer; color: #fff; font-weight: bold;">Sim, Excluir</button>
        </div>
    </div>
</div>

<!-- MODAL: DETALHES DA SESS√ÉO (Status e A√ß√µes) -->
<div id="modal-event-details" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box">
        <button class="modal-close-btn" id="close-event-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <h3 style="margin-top: 0; color: #1B4332;">Detalhes da Sess√£o</h3>
        
        <div style="margin-bottom: 20px;">
            <h2 id="evt-patient-name" style="margin: 0; font-size: 1.4rem; color: #333;">Nome do Paciente</h2>
            <p id="evt-time-info" style="color: #666; margin: 5px 0;">Data e Hora</p>
        </div>

        <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
            <label style="display: block; font-size: 0.85rem; color: #666; margin-bottom: 8px;">Status do Atendimento:</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-status" data-status="confirmed" style="flex: 1; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    üëç Confirmar
                </button>
                <button class="btn-status" data-status="done" style="flex: 1; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    ‚úÖ Realizado
                </button>
                <button class="btn-status" data-status="cancelled" style="flex: 1; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    ‚ùå Cancelar
                </button>
                <button class="btn-status" data-status="rescheduled" style="flex: 1; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    üóìÔ∏è Reagendar
                </button>
            </div>
        </div>

        <!-- Op√ß√µes condicionais -->
        <div id="evt-options-done" style="display: none; margin-bottom: 20px;">
            <div class="form-group">
                <label>Valor Cobrado (R$)</label>
                <input type="number" id="evt-value" class="form-control" style="width: 100%; box-sizing: border-box;">
            </div>
        </div>

        <div id="evt-options-missed" style="display: none; margin-bottom: 20px;">
            <div class="form-group-checkbox" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="evt-charge-missed">
                <label for="evt-charge-missed" style="margin: 0;">Cobrar sess√£o mesmo com falta?</label>
            </div>
        </div>

        <div id="evt-options-reschedule" style="display: none; margin-bottom: 20px;">
            <label style="display: block; font-size: 0.85rem; color: #666; margin-bottom: 8px;">Escolha um novo hor√°rio dispon√≠vel:</label>
            <div id="reschedule-slots-list" style="display: flex; flex-direction: column; gap: 8px; max-height: 150px; overflow-y: auto; border: 1px solid #eee; padding: 5px; border-radius: 8px;"></div>
        </div>

        <div class="form-actions" style="justify-content: flex-end; display: flex; gap: 10px;">
            <button type="button" id="btn-save-event-status" class="btn btn-principal">Salvar Status</button>
        </div>
    </div>
</div>

<script>
    // --- L√ìGICA DO FRONTEND (INTEGRADA) ---
    (async function() {
        const BASE_URL = (typeof window.API_BASE_URL !== 'undefined') ? window.API_BASE_URL : 'http://localhost:3001';
        const token = localStorage.getItem('Yelo_token');

        let patients = [];
        let events = [];

        // Elementos DOM

        const listContainer = document.getElementById('patient-list');
        const countBadge = document.getElementById('patient-count');
        const searchInput = document.getElementById('search-patient');
        const statusFilter = document.getElementById('filter-patient-status');
        const pStatusInput = document.getElementById('p-status');
        const modal = document.getElementById('modal-patient');
        const form = document.getElementById('form-patient');
        const pIdInput = document.getElementById('p-id');
        const btnDelete = document.getElementById('btn-delete-patient');
        const btnSimulate = document.getElementById('btn-simulate-reminder');
        
        // Elementos do Modal de Exclus√£o
        const modalDelete = document.getElementById('modal-delete-confirmation');
        const btnConfirmDelete = document.getElementById('btn-confirm-delete');
        const btnCancelDelete = document.getElementById('btn-cancel-delete');

        // Elementos do Modal de Agendamento
        const modalAppt = document.getElementById('modal-appointment');
        const formAppt = document.getElementById('form-appointment');
        const selectPatient = document.getElementById('appt-patient');

        // --- CUSTOM SELECT (FILTRO DE STATUS) ---
        const statusFilterWrapper = document.querySelector('.custom-select-wrapper');
        const statusFilterTrigger = document.getElementById('status-filter-trigger');
        const statusFilterOptions = document.getElementById('status-filter-options');
        const statusFilterSelectedText = document.getElementById('status-filter-selected-text');

        if (statusFilterTrigger) {
            statusFilterTrigger.addEventListener('click', () => {
                statusFilterWrapper.classList.toggle('open');
            });

            statusFilterOptions.addEventListener('click', (e) => {
                if (e.target.classList.contains('custom-option')) {
                    const oldSelected = statusFilterOptions.querySelector('.custom-option.selected');
                    if (oldSelected) oldSelected.classList.remove('selected');
                    
                    e.target.classList.add('selected');
                    
                    const newValue = e.target.getAttribute('data-value');
                    const newText = e.target.textContent;

                    statusFilterSelectedText.textContent = newText;
                    statusFilter.value = newValue; // Atualiza o input hidden

                    statusFilterWrapper.classList.remove('open');
                    renderList(searchInput.value, newValue);
                }
            });

            window.addEventListener('click', (e) => {
                if (statusFilterWrapper && !statusFilterWrapper.contains(e.target)) {
                    statusFilterWrapper.classList.remove('open');
                }
            });
        }

        // Elementos Financeiros
        const modalEvent = document.getElementById('modal-event-details');
        
        // --- API FUNCTIONS ---
        async function fetchData() {
            try {
                // 1. Buscar Pacientes
                const resPatients = await fetch(`${BASE_URL}/api/my-patients`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (resPatients.ok) {
                    const data = await resPatients.json();
                    // Mapeia para o formato interno
                    patients = data.map(p => ({
                        id: p.id, name: p.nome, phone: p.telefone, email: p.email, automated: true, sessionValue: p.sessionValue || 0, status: p.status || 'ativo'
                    }));
                }

                // 2. Buscar Agendamentos
                const resAppts = await fetch(`${BASE_URL}/api/appointments`, { headers: { 'Authorization': `Bearer ${token}` } });
                if (resAppts.ok) {
                    const allEvents = await resAppts.json();
                    // Filtra para n√£o mostrar agendamentos √≥rf√£os (de pacientes exclu√≠dos)
                    events = allEvents.filter(evt => {
                        if (evt.status === 'available') return true; // Mant√©m hor√°rios livres
                        return patients.some(p => p.id == evt.patientId); // S√≥ mostra se o paciente existe
                    });
                }

                renderList('', 'ativo');
                renderNextSessions();
                initCalendar();
            } catch (e) { console.error("Erro ao carregar dados:", e); }
        }

        // --- RENDERIZAR PR√ìXIMAS SESS√ïES ---
        function renderNextSessions() {
            const container = document.getElementById('next-sessions-container');
            const list = document.getElementById('next-sessions-list');
            list.innerHTML = '';

            // Filtra eventos futuros e agendados
            // Ajuste: Filtra eventos com status 'scheduled'
            const upcoming = events
                .filter(e => e.status === 'scheduled' || e.status === 'confirmed')
                .sort((a, b) => new Date(a.start) - new Date(b.start))
                .slice(0, 5); // Pega os 5 primeiros

            if (upcoming.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            upcoming.forEach(evt => {
                const dateObj = new Date(evt.start);
                const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = dateObj.toLocaleDateString([], { day: '2-digit', month: 'short' });
                
                // Define o texto e a cor do status
                let statusText = 'Aguardando';
                let statusColor = '#666';
                
                if (evt.status === 'confirmed') {
                    statusText = 'Confirmado';
                    statusColor = '#1B4332';
                }

                const el = document.createElement('div');
                el.className = 'next-session-card';
                el.innerHTML = `
                    <div class="ns-time"><span>${timeStr}</span><span style="font-size:0.7rem; font-weight:normal;">${dateStr}</span></div>
                    <div class="ns-info">
                        <h5>${evt.title}</h5>
                        <span style="color: ${statusColor}; font-weight: 600; font-size: 0.8rem;">${statusText}</span>
                    </div>
                    <div style="color:#ccc;">‚ûî</div>
                `;
                el.onclick = () => openEventDetails(evt); // Reutiliza a fun√ß√£o de abrir detalhes
                list.appendChild(el);
            });
        }

        // 1. Renderizar Lista
        function renderList(searchTerm = '', statusFilterValue = 'ativo') {
            listContainer.innerHTML = '';
            const filteredByName = patients.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));

            const finalFiltered = filteredByName.filter(p => {
                if (statusFilterValue === 'todos') return true;
                // Garante que pacientes sem status sejam tratados como ativos no filtro padr√£o
                const pStatus = (p.status || 'ativo').toLowerCase();
                const normalizedStatus = pStatus === 'active' ? 'ativo' : pStatus;
                return normalizedStatus === statusFilterValue;
            });
            
            countBadge.textContent = finalFiltered.length;

            // Atualiza o select do modal de agendamento
            selectPatient.innerHTML = '<option value="">Selecione...</option>';
            patients.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name; // Usando nome como ID simplificado
                opt.textContent = p.name;
                selectPatient.appendChild(opt);
            });

            if (finalFiltered.length === 0) {
                listContainer.innerHTML = '<div class="empty-state-patients"><p>Nenhum paciente encontrado.</p></div>';
                return;
            }

            finalFiltered.forEach(p => {
                // Gera iniciais para o avatar
                const initials = p.name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();

                const item = document.createElement('div');
                item.className = 'patient-card';
                item.innerHTML = `
                    <div class="patient-avatar">${initials}</div>
                    <div class="patient-info">
                        <h4>${p.name}</h4>
                        <span>${p.phone}</span>
                    </div>
                    <span class="patient-status-badge status-${p.status || 'ativo'}">${p.status || 'ativo'}</span>
                    <div class="patient-status" title="${p.automated ? 'Assistente Ativa' : 'Assistente Inativa'}">
                        ${p.automated ? 'ü§ñ' : 'üîï'}
                    </div>
                    <div style="font-weight:bold; color:#1B4332; font-size:0.9rem; margin-left: 10px;">R$ ${p.sessionValue || 0}</div>
                `;
                
                // Clique no card abre edi√ß√£o
                item.onclick = () => openEditModal(p);
                
                listContainer.appendChild(item);
            });
        }

        // 2. Inicializar Calend√°rio (FullCalendar)
        function initCalendar() {
            const calendarEl = document.getElementById('calendar-wrapper');
            if (!calendarEl) return;

            const mobile = window.innerWidth < 768;
            const isDesktop = window.innerWidth >= 992;

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: mobile ? 'timeGridDay' : 'timeGridWeek', // Mobile: Dia | Desktop: Semana
                locale: 'pt-br',
                selectable: true, // Permite sele√ß√£o visual
                editable: true, // Habilita arrastar e soltar (Drag & Drop)
                eventDrop: async function(info) {
                    // Reagendamento (Drag & Drop)
                    const evtId = info.event.id;
                    const newStart = info.event.start.toISOString();
                    const newEnd = info.event.end ? info.event.end.toISOString() : null;
                    
                    // Busca telefone do paciente para notificar
                    const evtData = events.find(e => e.id == evtId);
                    const patient = patients.find(p => p.id == evtData.patientId);

                    try {
                        await fetch(`${BASE_URL}/api/appointments/${evtId}`, {
                            method: 'PUT',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}` 
                            },
                            body: JSON.stringify({ 
                                start: newStart, 
                                end: newEnd,
                                phone: patient ? patient.phone : null,
                                title: evtData.title
                            })
                        });
                        if(window.showToast) window.showToast('Sess√£o reagendada e paciente notificado.', 'success');
                    } catch (e) {
                        info.revert(); // Desfaz se der erro
                        alert('Erro ao reagendar.');
                    }
                },
                eventResize: function(info) {
                    // Atualiza a dura√ß√£o no array local
                    const evt = events.find(e => e.id == info.event.id);
                    if (evt) {
                        evt.end = info.event.end.toISOString();
                        if(window.showToast) window.showToast('Dura√ß√£o da sess√£o atualizada.', 'success');
                    }
                },
                headerToolbar: mobile ? {
                    left: 'title',
                    right: 'prev,next'
                } : {
                    left: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay today prev,next'
                },
                buttonText: {
                    today: 'Hoje',
                    month: 'M√™s',
                    week: 'Semana',
                    day: 'Dia'
                },
                slotMinTime: '00:00:00',
                slotMaxTime: '24:00:00',
                scrollTime: '07:00:00',
                allDaySlot: false,
                slotDuration: '01:00:00', // Slots de 1 hora para ficar mais limpo
                height: isDesktop ? '100%' : '75vh', // Desktop: 100% | Mobile: 75vh para scroll interno
                nowIndicator: true, // Indicador de hora atual
                titleFormat: mobile ? { year: 'numeric', month: 'short', day: 'numeric' } : undefined,
                
                // --- CONFIGURA√á√ïES MOBILE ---
                windowResize: function(arg) {
                    const width = window.innerWidth;
                    const isSmall = width < 768;
                    calendar.setOption('height', width >= 992 ? '100%' : '75vh');

                    if (isSmall) {
                        calendar.changeView('timeGridDay');
                        calendar.setOption('headerToolbar', {
                            left: 'prev,next',
                            center: 'title',
                            right: 'today'
                        });
                        calendar.setOption('titleFormat', { year: 'numeric', month: 'short', day: 'numeric' });
                    } else {
                        calendar.changeView('timeGridWeek');
                        calendar.setOption('headerToolbar', {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        });
                        calendar.setOption('titleFormat', undefined);
                    }
                },
                views: {
                    timeGridDay: {
                        titleFormat: { year: 'numeric', month: 'short', day: 'numeric' } // T√≠tulo curto no mobile
                    }
                },

                events: events.map(evt => ({
                    ...evt,
                    // Cores: Agendado (Azul), Confirmado (Verde), Realizado (Cinza), Cancelado/Falta (Vermelho)
                    display: evt.status === 'cancelled' ? 'background' : 'auto', // LIBERA O HOR√ÅRIO SE CANCELADO
                    color: evt.status === 'confirmed' ? '#1B4332' : 
                           evt.status === 'scheduled' ? '#3788d8' : 
                           evt.status === 'done' ? '#9e9e9e' : 
                           evt.status === 'available' ? '#FFC107' :
                           (evt.status === 'cancelled' || evt.status === 'missed') ? '#ffebee' : '#3788d8' // Vermelho claro para background
                })),
                // Clique em um hor√°rio vazio
                dateClick: function(info) {
                    const date = info.date;
                    // Ajusta fuso hor√°rio local para os inputs
                    const dateStr = date.toLocaleDateString('en-CA'); // YYYY-MM-DD
                    const timeStr = date.toTimeString().split(' ')[0].substring(0, 5); // HH:MM
                    
                    openAppointmentModal(dateStr, timeStr);
                },
                // Clique em um evento existente
                eventClick: function(info) {
                    openEventDetails(info.event);
                }
            });
            calendar.render();
            window.calendarApi = calendar;

            // --- SWIPE NAVIGATION (MOBILE) ---
            let touchStartX = 0;
            let touchEndX = 0;
            
            calendarEl.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, {passive: true});

            calendarEl.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                if (touchEndX < touchStartX - 50) calendar.next(); // Swipe Left -> Pr√≥ximo
                if (touchEndX > touchStartX + 50) calendar.prev(); // Swipe Right -> Anterior
            }, {passive: true});
        }

        // 3. Fun√ß√µes do Modal
        function openEditModal(patient) {
            form.reset();
            pIdInput.value = String(patient.id); // Garante que seja string para o form
            document.getElementById('p-name').value = patient.name;
            document.getElementById('p-phone').value = patient.phone;
            document.getElementById('p-email').value = (patient.email && patient.email.includes('@temp.com')) ? '' : patient.email;
            document.getElementById('p-session-value').value = patient.sessionValue;
            pStatusInput.value = patient.status || 'ativo';
            document.getElementById('p-automated-msg').checked = patient.automated;
            
            document.getElementById('modal-patient-title').textContent = 'Editar Paciente';
            btnDelete.style.display = 'block'; // Mostra lixeira
            btnSimulate.style.display = 'block'; // Mostra bot√£o de simular
            modal.style.display = 'flex';
        }

        function openNewPatientModal() {
            form.reset();
            pIdInput.value = ''; // Limpa ID para indicar novo
            document.getElementById('modal-patient-title').textContent = 'Novo Paciente';
            document.getElementById('p-email').value = '';
            pStatusInput.value = 'ativo';
            btnDelete.style.display = 'none'; // Esconde lixeira
            btnSimulate.style.display = 'none'; // Esconde bot√£o de simular
            modal.style.display = 'flex';
        }

        function openAppointmentModal(dateStr, timeStr) {
            formAppt.reset();
            if(dateStr) document.getElementById('appt-date').value = dateStr;
            if(timeStr) document.getElementById('appt-time').value = timeStr;
            
            document.getElementById('modal-appointment-title').textContent = 'Novo Agendamento';
            modalAppt.style.display = 'flex';
        }

        // Toggle de campos no modal de agendamento
        document.getElementById('appt-type').addEventListener('change', (e) => {
            const type = e.target.value;
            const patientGroup = document.getElementById('group-patient-select');
            const patientSelect = document.getElementById('appt-patient');
            
            patientGroup.style.display = type === 'available' ? 'none' : 'block';
            patientSelect.required = type === 'session';
        });

        // Fun√ß√£o unificada para abrir modal de novo paciente
        const handleNewPatient = () => {
            form.reset();
            pIdInput.value = ''; // Limpa ID para indicar novo
            pStatusInput.value = 'ativo';
            document.getElementById('modal-patient-title').textContent = 'Novo Paciente';
            btnDelete.style.display = 'none'; // Esconde lixeira
            btnSimulate.style.display = 'none';
            modal.style.display = 'flex';
        };

        document.getElementById('btn-add-patient').onclick = handleNewPatient;
        document.getElementById('btn-add-patient-mobile').onclick = handleNewPatient;
        
        const closeModal = () => modal.style.display = 'none';
        document.getElementById('close-patient-modal').onclick = closeModal;
        document.getElementById('cancel-patient-modal').onclick = closeModal;

        const closeApptModal = () => modalAppt.style.display = 'none';
        document.getElementById('close-appointment-modal').onclick = closeApptModal;
        document.getElementById('cancel-appointment-modal').onclick = closeApptModal;

        // Fechar modais financeiros
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', () => document.querySelectorAll('.custom-modal-overlay').forEach(m => m.style.display = 'none'));
        });

        // A√ß√£o: Abrir Modal de Exclus√£o
        btnDelete.onclick = () => {
            modalDelete.style.display = 'flex';
        };

        // A√ß√£o: Cancelar Exclus√£o
        btnCancelDelete.onclick = () => {
            modalDelete.style.display = 'none';
        };

        // A√ß√£o: Confirmar Exclus√£o (API REAL)
        btnConfirmDelete.onclick = async () => {
            const id = document.getElementById('p-id').value;
            if (!id) return;

            btnConfirmDelete.textContent = "Excluindo...";
            
            try {
                const res = await fetch(`${BASE_URL}/api/my-patients/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (res.ok) {
                    fetchData(); // Recarrega a lista do servidor
                    modalDelete.style.display = 'none';
                    closeModal();
                    if(window.showToast) window.showToast('Paciente removido do banco de dados.', 'success');
                } else {
                    alert('Erro ao excluir paciente.');
                }
            } catch (e) {
                alert('Erro de conex√£o ao excluir.');
            } finally {
                btnConfirmDelete.textContent = "Sim, Excluir";
            }
        };

        // A√ß√£o: Simular Lembrete
        btnSimulate.onclick = async () => {
            const patientId = pIdInput.value;
            const now = new Date();
            
            // Encontra o pr√≥ximo agendamento futuro deste paciente
            const nextAppt = events
                .filter(e => e.patientId == patientId && e.status === 'scheduled' && new Date(e.start) > now)
                .sort((a, b) => new Date(a.start) - new Date(b.start))[0];

            if (!nextAppt) {
                alert('Este paciente n√£o possui agendamentos futuros confirmados para enviar lembrete.');
                return;
            }

            if(confirm(`Enviar lembrete agora para a sess√£o de ${new Date(nextAppt.start).toLocaleString()}?`)) {
                // UX: Feedback visual de carregamento
                const originalText = btnSimulate.textContent;
                btnSimulate.disabled = true;
                btnSimulate.textContent = "Enviando...";
                btnSimulate.style.opacity = "0.7";

                try {
                    const res = await fetch(`${BASE_URL}/api/appointments/${nextAppt.id}/remind`, { method: 'POST' });
                    if (res.ok) {
                        if(window.showToast) window.showToast('Lembrete enviado (Simulado no Console do Servidor).', 'success');
                        closeModal();
                    }
                } catch (e) { alert('Erro ao enviar lembrete.'); }
                finally {
                    btnSimulate.disabled = false;
                    btnSimulate.textContent = originalText;
                    btnSimulate.style.opacity = "1";
                }
            }
        };

                // Salvar (Novo ou Edi√ß√£o)
        form.onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('p-id').value; // Pega o ID diretamente do DOM para garantir
            const name = document.getElementById('p-name').value;
            const phone = document.getElementById('p-phone').value;
            const email = document.getElementById('p-email').value;
            const status = pStatusInput.value;
            const sessionValue = parseFloat(document.getElementById('p-session-value').value) || 0;
            
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${BASE_URL}/api/my-patients/${id}` : `${BASE_URL}/api/my-patients`;
            
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ name, phone, email, status, sessionValue })
                });
                
                if (res.ok) {
                    fetchData(); // Recarrega tudo
                    closeModal();
                    if(window.showToast) window.showToast('Paciente salvo.', 'success');
                } else {
                    const err = await res.json();
                    alert('Erro ao salvar paciente: ' + (err.error || 'Erro desconhecido'));
                }
            } catch (e) {
                console.error(e);
                alert('Erro de conex√£o ao salvar paciente.');
            }
        };


        // Salvar Agendamento
        formAppt.onsubmit = async (e) => {
            e.preventDefault();
            
            const type = document.getElementById('appt-type').value;
            const patientName = selectPatient.value;
            const patient = patients.find(p => p.name === patientName);
            const date = document.getElementById('appt-date').value;
            const time = document.getElementById('appt-time').value;
            
            if ((type === 'session' && !patient) || !date || !time) return;

            const start = new Date(`${date}T${time}`);
            const end = new Date(start.getTime() + 60 * 60 * 1000); // +1 hora

            try {
                const res = await fetch(`${BASE_URL}/api/appointments`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({
                        title: type === 'available' ? 'Hor√°rio Dispon√≠vel' : patient.name,
                        start: start.toISOString(),
                        end: end.toISOString(),
                        patientId: type === 'available' ? null : patient.id,
                        phone: (type === 'session' && patient) ? patient.phone : null,
                        status: type === 'available' ? 'available' : 'scheduled'
                    })
                });

                if (res.ok) {
                    fetchData(); // Recarrega calend√°rio
                    closeApptModal();
                    if(window.showToast) window.showToast(type === 'available' ? 'Hor√°rio dispon√≠vel criado.' : 'Agendado e notificado!', 'success');
                } else {
                    const errData = await res.json();
                    alert('Erro ao criar agendamento: ' + (errData.error || 'Verifique os dados.'));
                }
            } catch (e) {
                alert('Erro ao agendar.');
            }
        };

        // --- L√ìGICA DE DETALHES DO EVENTO ---
        let currentEventId = null;
        function openEventDetails(fcEvent) {
            const evt = events.find(e => e.id == fcEvent.id);
            if(!evt) return;
            
            currentEventId = evt.id;
            document.getElementById('evt-patient-name').textContent = evt.title;
            document.getElementById('evt-time-info').textContent = new Date(evt.start).toLocaleString('pt-BR');
            document.getElementById('evt-value').value = evt.value;
            
            // Reset UI
            document.querySelectorAll('.btn-status').forEach(b => {
                b.style.background = '#fff'; b.style.color = '#333'; b.style.borderColor = '#ddd';
            });
            document.getElementById('evt-options-done').style.display = 'none';
            document.getElementById('evt-options-missed').style.display = 'none';
            document.getElementById('evt-options-reschedule').style.display = 'none';

            // Seleciona status atual se houver
            if(evt.status) {
                const btn = document.querySelector(`.btn-status[data-status="${evt.status}"]`);
                if(btn) highlightStatusBtn(btn, evt.status);
                if(evt.status === 'done') document.getElementById('evt-options-done').style.display = 'block';
                // Reutiliza op√ß√µes de falta para cancelado se necess√°rio, ou esconde
                if(evt.status === 'missed') document.getElementById('evt-options-missed').style.display = 'block';
            }

            modalEvent.style.display = 'flex';
        }

        function highlightStatusBtn(btn, status) {
            if(status === 'confirmed') { btn.style.background = '#e8f5e9'; btn.style.borderColor = '#1B4332'; btn.style.color = '#1B4332'; }
            if(status === 'done') { btn.style.background = '#f0f0f0'; btn.style.borderColor = '#999'; btn.style.color = '#555'; }
            if(status === 'rescheduled') { btn.style.background = '#fff3e0'; btn.style.borderColor = '#f57c00'; btn.style.color = '#f57c00'; }
            if(status === 'cancelled') { btn.style.background = '#ffebee'; btn.style.borderColor = '#d32f2f'; btn.style.color = '#d32f2f'; }
        }

        document.querySelectorAll('.btn-status').forEach(btn => {
            btn.onclick = () => {
                const status = btn.dataset.status;
                document.querySelectorAll('.btn-status').forEach(b => {
                    b.style.background = '#fff'; b.style.color = '#333'; b.style.borderColor = '#ddd';
                });
                highlightStatusBtn(btn, status);
                
                // --- FEATURE: Preencher valor ao marcar como realizado ---
                if (status === 'done') {
                    const evt = events.find(e => e.id == currentEventId);
                    const valInput = document.getElementById('evt-value');
                    // S√≥ preenche se o campo estiver vazio ou zerado (para n√£o sobrescrever edi√ß√µes manuais)
                    if (evt && (!valInput.value || parseFloat(valInput.value) === 0)) {
                        const patient = patients.find(p => p.id == evt.patientId);
                        if (patient && patient.sessionValue) {
                            valInput.value = patient.sessionValue;
                        }
                    }
                }

                document.getElementById('evt-options-done').style.display = status === 'done' ? 'block' : 'none';
                document.getElementById('evt-options-missed').style.display = 'none'; // Esconde op√ß√µes extras ao mudar
                
                // --- L√ìGICA DE REAGENDAMENTO ---
                const rescheduleContainer = document.getElementById('evt-options-reschedule');
                if (status === 'rescheduled') {
                    rescheduleContainer.style.display = 'block';
                    const list = document.getElementById('reschedule-slots-list');
                    list.innerHTML = '';

                    // Busca hor√°rios dispon√≠veis futuros
                    const now = new Date();
                    const availableSlots = events
                        .filter(e => e.status === 'available' && new Date(e.start) > now)
                        .sort((a, b) => new Date(a.start) - new Date(b.start))
                        .slice(0, 5); // Top 5

                    if (availableSlots.length === 0) {
                        list.innerHTML = '<div style="padding:10px; color:#999; font-size:0.9rem;">Nenhum hor√°rio "Dispon√≠vel" futuro encontrado na agenda.</div>';
                    } else {
                        availableSlots.forEach(slot => {
                            const btn = document.createElement('button');
                            const dateStr = new Date(slot.start).toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: '2-digit' });
                            const timeStr = new Date(slot.start).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                            
                            btn.innerHTML = `üìÖ <strong>${dateStr}</strong> √†s <strong>${timeStr}</strong>`;
                            btn.style.cssText = "padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; cursor: pointer; text-align: left; transition: background 0.2s;";
                            btn.onmouseover = () => btn.style.background = "#f0fdf4";
                            btn.onmouseout = () => btn.style.background = "#fff";
                            
                            btn.onclick = () => realizarReagendamento(currentEventId, slot);
                            list.appendChild(btn);
                        });
                    }
                } else {
                    rescheduleContainer.style.display = 'none';
                }
            };
        });

        document.getElementById('btn-save-event-status').onclick = async () => {
            const activeBtn = document.querySelector('.btn-status[style*="background"]');
            if(!activeBtn) return;
            
            const status = activeBtn.dataset.status;
            const evt = events.find(e => e.id == currentEventId);
            const patient = evt.patientId ? patients.find(p => p.id == evt.patientId) : null;
            
            try {
                await fetch(`${BASE_URL}/api/appointments/${currentEventId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ 
                        status, 
                        value: parseFloat(document.getElementById('evt-value').value) || 0,
                        phone: patient ? patient.phone : null,
                        title: evt.title
                    })
                });
                
                fetchData(); // Atualiza UI e Financeiro
                modalEvent.style.display = 'none';
                if (status === 'rescheduled') {
                    if(window.showToast) window.showToast('Op√ß√µes de hor√°rio enviadas ao paciente.', 'success');
                } else {
                    if(window.showToast) window.showToast('Status atualizado!', 'success');
                }
            } catch (e) {
                alert('Erro ao atualizar status.');
            }
        };

        // Fun√ß√£o auxiliar para reagendar ao clicar no slot
        async function realizarReagendamento(eventId, newSlot) {
            if(!confirm("Confirmar reagendamento para este hor√°rio?")) return;
            
            const evt = events.find(e => e.id == eventId);
            const patient = evt.patientId ? patients.find(p => p.id == evt.patientId) : null;

            try {
                await fetch(`${BASE_URL}/api/appointments/${eventId}`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify({ 
                        status: 'scheduled', // Volta para agendado na nova data
                        start: newSlot.start,
                        end: newSlot.end,
                        phone: patient ? patient.phone : null,
                        title: evt.title
                    })
                });
                fetchData(); // Recarrega calend√°rio
                modalEvent.style.display = 'none';
                if(window.showToast) window.showToast('Reagendado com sucesso!', 'success');
            } catch (e) { alert('Erro ao reagendar.'); }
        }

        searchInput.oninput = (e) => renderList(e.target.value, statusFilter.value);

        // Inicializa√ß√£o
        fetchData();

        // M√°scara de telefone (se IMask estiver dispon√≠vel)
        if (typeof IMask !== 'undefined') {
            IMask(document.getElementById('p-phone'), { mask: '(00) 00000-0000' });
        }

        // Valida√ß√£o do campo Valor da Sess√£o (Impedir letras 'e', 'E', '+', '-')
        const sessionInput = document.getElementById('p-session-value');
        if (sessionInput) {
            sessionInput.addEventListener('keydown', (e) => {
                if (['e', 'E', '+', '-'].includes(e.key)) {
                    e.preventDefault();
                }
            });
        }
    })();
</script>