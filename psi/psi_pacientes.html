<style>
    /* --- FullCalendar Customization (Melhoria de UX/Leitura) --- */
    .fc-header-toolbar {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        margin-bottom: 20px !important;
        flex-wrap: wrap;
        gap: 10px;
    }

    .fc-toolbar-title {
        font-family: var(--font-titulos) !important;
        font-size: 1.4rem !important;
        color: var(--verde-escuro);
        font-weight: 600;
    }

    .fc-button {
        background-color: #fff !important;
        border: 1px solid #e0e0e0 !important;
        color: #555 !important;
        font-weight: 500 !important;
        border-radius: 8px !important;
        padding: 8px 16px !important;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02) !important;
        transition: all 0.2s ease !important;
        text-transform: capitalize !important;
    }

    .fc-button:hover {
        background-color: #f9f9f9 !important;
        border-color: #ccc !important;
        color: #333 !important;
        transform: translateY(-1px);
    }

    .fc-button-active {
        background-color: var(--verde-escuro) !important;
        border-color: var(--verde-escuro) !important;
        color: #fff !important;
    }
    
    .fc-button-group > .fc-button {
        margin: 0 2px !important; /* Pequeno espa√ßo entre bot√µes agrupados */
    }

    /* Alinhamento do Header da Carteira de Pacientes */
    .widget-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #eee;
    }

    .widget-header-row h3 {
        margin: 0 !important;
        padding: 0 !important;
        border: none !important;
    }
    
    .badge-count {
        background-color: #e8f5e9;
        color: var(--verde-escuro);
        font-weight: bold;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9rem;
        border: 1px solid #cce5d4;
    }

    .patient-status-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: capitalize;
        margin-left: auto; /* Empurra para a direita */
        margin-right: 10px; /* Espa√ßo antes do pr√≥ximo √≠cone */
    }
    .status-ativo { background-color: #e8f5e9; color: #1B4332; }
    .status-inativo { background-color: #f1f3f5; color: #6c757d; }

    /* --- Custom Select (Yelo Aesthetic) --- */
    .custom-select-wrapper {
        position: relative;
        width: 150px; /* Largura ajust√°vel */
    }

    .custom-select-trigger {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        border-radius: 20px;
        border: 1px solid #eee;
        background-color: #f9fafb;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    .custom-select-wrapper:hover .custom-select-trigger {
        border-color: var(--verde-escuro);
    }

    .custom-select-arrow { transition: transform 0.3s ease; }
    .custom-select-wrapper.open .custom-select-arrow { transform: rotate(180deg); }

    .custom-select-options {
        position: absolute;
        top: calc(100% + 5px);
        left: 0;
        width: 100%;
        background: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        z-index: 10;
        overflow: hidden;
        display: none;
        animation: fadeIn 0.2s;
    }
    .custom-select-wrapper.open .custom-select-options { display: block; }
    .custom-option { padding: 12px 15px; cursor: pointer; transition: background-color 0.2s; }
    .custom-option:hover { background-color: #f0fdf4; color: var(--verde-escuro); }
    .custom-option.selected { background-color: var(--verde-escuro); color: #fff; font-weight: 600; }

    /* --- Next Sessions Widget --- */
    .next-session-card {
        min-width: 220px;
        background: #f9fafb;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 12px 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: all 0.2s;
        cursor: pointer;
    }
    .next-session-card:hover {
        transform: translateY(-2px);
        border-color: var(--verde-escuro);
        background: #fff;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .ns-time {
        background: #e8f5e9;
        color: #1B4332;
        padding: 6px 10px;
        border-radius: 8px;
        font-weight: 800;
        font-size: 0.9rem;
        text-align: center;
        display: flex;
        flex-direction: column;
        line-height: 1.1;
    }
    .ns-info { flex-grow: 1; overflow: hidden; }
    .ns-info h5 { margin: 0; font-size: 0.95rem; color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .ns-info span { font-size: 0.8rem; color: #666; }
</style>

<div class="main-header">
    <div class="header-content">
        <h1>Meus Pacientes</h1>
        <p>Gerencie seus atendimentos e sua agenda.</p>
    </div>
    <div class="dashboard-header-actions">
        <button id="btn-add-patient" class="btn" style="background-color: #fff; color: #1B4332; display: flex; align-items: center; gap: 8px; border: 1px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <span style="font-size: 1.2rem; line-height: 0;">+</span> Novo Paciente
        </button>
    </div>
</div>

    <div class="patients-layout-grid">
    
    <!-- COLUNA 1: LISTA DE PACIENTES -->
    <div class="widget" style="display: flex; flex-direction: column; height: 100%;">
        <div class="widget-header-row">
            <h3 class="widget-title">Carteira de Pacientes</h3>
            <span class="badge-count" id="patient-count">0</span>
        </div>

        <div style="display: flex; gap: 15px; margin-bottom: 15px; align-items: center;">
            <div class="search-wrapper" style="flex-grow: 1; margin-bottom: 0;">
                <input type="text" id="search-patient" placeholder="Buscar por nome..." class="form-control" style="width: 100%; box-sizing: border-box; border-radius: 20px; padding: 12px 20px; border: 1px solid #eee; background-color: #f9fafb;">
            </div>
            <div class="custom-select-wrapper" style="flex-shrink: 0;">
                <div class="custom-select-trigger" id="status-filter-trigger">
                    <span id="status-filter-selected-text">Ativos</span>
                    <span class="custom-select-arrow">‚ñº</span>
                </div>
                <div class="custom-select-options" id="status-filter-options">
                    <div class="custom-option selected" data-value="ativo">Ativos</div>
                    <div class="custom-option" data-value="inativo">Inativos</div>
                    <div class="custom-option" data-value="todos">Todos</div>
                </div>
                <input type="hidden" id="filter-patient-status" value="ativo">
            </div>
        </div>

        <div class="patient-list-container" id="patient-list">
            <!-- Lista renderizada via JS -->
            <div class="empty-state-patients">
                <p>Nenhum paciente cadastrado.</p>
            </div>
        </div>
    </div>

    <!-- COLUNA 2: CALEND√ÅRIO -->
    <div class="widget">
        <!-- PR√ìXIMAS SESS√ïES -->
        <div id="next-sessions-container" style="margin-bottom: 25px; display: none;">
            <h4 style="margin: 0 0 15px 0; color: #1B4332; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                <span style="background:#e8f5e9; padding:4px; border-radius:50%;">‚ö°</span> Pr√≥ximos Atendimentos
            </h4>
            <div id="next-sessions-list" style="display: flex; gap: 15px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: thin;"></div>
        </div>

        <div class="widget-header-row">
            <h3 class="widget-title">Agenda</h3>
            <div class="calendar-legend">
                <span class="legend-item"><span class="dot" style="background-color: #1B4332;"></span> Agendado</span>
                <span class="legend-item"><span class="dot" style="background-color: #9e9e9e;"></span> Realizado</span>
                <span class="legend-item"><span class="dot" style="background-color: #d32f2f;"></span> Falta</span>
            </div>
        </div>
        <div id="calendar-wrapper" style="flex-grow: 1;"></div>
    </div>
</div>

<!-- MODAL: ADICIONAR/EDITAR PACIENTE -->
<div id="modal-patient" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box">
        <button class="modal-close-btn" id="close-patient-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <h3 id="modal-patient-title" style="margin-top: 0; color: #1B4332;">Novo Paciente</h3>
        
        <form id="form-patient">
            <input type="hidden" id="p-id"> <!-- ID oculto para edi√ß√£o -->
            <div class="form-group">
                <label>Nome Completo *</label>
                <input type="text" id="p-name" required placeholder="Ex: Jo√£o Silva">
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>WhatsApp *</label>
                    <input type="tel" id="p-phone" required placeholder="(00) 00000-0000">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>E-mail (Opcional)</label>
                    <input type="email" id="p-email" placeholder="joao@email.com">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Valor da Sess√£o (R$)</label>
                    <input type="number" id="p-session-value" placeholder="0,00" step="0.01" required>
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Status do Paciente</label>
                    <select id="p-status" required class="form-control" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background-color: #f9fafb;">
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                    </select>
                </div>
            </div>

            <div class="form-group highlight-box assistant-card" style="margin-top: 15px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div class="assistant-icon">ü§ñ</div>
                    <div>
                        <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                            <label for="p-automated-msg" style="font-weight: bold; color: #1B4332; cursor: pointer; font-size: 1rem;">Ativar Assistente Pessoal</label>
                            <label class="switch-toggle">
                                <input type="checkbox" id="p-automated-msg" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        <p style="font-size: 0.85rem; color: #555; margin: 8px 0 0 0; line-height: 1.4;">
                            Enviaremos lembretes autom√°ticos de sess√£o e confirma√ß√£o de hor√°rio via WhatsApp.
                        </p>
                    </div>
                </div>
            </div>

            <div class="form-actions" style="justify-content: space-between; margin-top: 25px; display: flex; align-items: center;">
                <!-- Bot√£o de Excluir (S√≥ aparece na edi√ß√£o) -->
                <button type="button" id="btn-delete-patient" style="display: none; background: none; border: none; color: #d32f2f; cursor: pointer; padding: 8px; border-radius: 50%; transition: background 0.2s;" title="Excluir Paciente">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                </button>

                <div style="display: flex; gap: 10px; margin-left: auto;">
                    <button type="button" class="btn btn-secundario" id="cancel-patient-modal">Cancelar</button>
                    <button type="submit" class="btn btn-principal">Salvar</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: AGENDAMENTO (NOVO) -->
<div id="modal-appointment" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box">
        <button class="modal-close-btn" id="close-appointment-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <h3 id="modal-appointment-title" style="margin-top: 0; color: #1B4332;">Novo Agendamento</h3>
        
        <form id="form-appointment">
            <div class="form-group">
                <label>Paciente</label>
                <select id="appt-patient" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; background-color: #f9fafb;">
                    <option value="">Selecione...</option>
                    <!-- Preenchido via JS -->
                </select>
            </div>
            
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Data</label>
                    <input type="date" id="appt-date" required style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Hor√°rio</label>
                    <input type="time" id="appt-time" required step="300" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box;">
                </div>
            </div>

            <div class="form-group highlight-box assistant-card" style="margin-top: 15px;">
                <div style="display: flex; align-items: flex-start; gap: 15px;">
                    <div class="assistant-icon">üîÅ</div>
                    <div style="flex-grow: 1;">
                        <label for="appt-recurrence" style="font-weight: bold; color: #1B4332; display: block; margin-bottom: 8px;">Frequ√™ncia</label>
                        <select id="appt-recurrence" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; background-color: #fff;">
                            <option value="none">N√£o repetir (Sess√£o √önica)</option>
                            <option value="weekly">Semanalmente</option>
                            <option value="biweekly">Quinzenalmente</option>
                        </select>
                        <p style="font-size: 0.85rem; color: #555; margin: 8px 0 0 0; line-height: 1.4;">
                            Define se o agendamento se repetir√° automaticamente.
                        </p>
                    </div>
                </div>
            </div>

            <div class="form-actions" style="justify-content: flex-end; margin-top: 25px; display: flex; gap: 10px;">
                <button type="button" class="btn btn-secundario" id="cancel-appointment-modal">Cancelar</button>
                <button type="submit" class="btn btn-principal">Agendar</button>
            </div>
        </form>
    </div>
</div>

<!-- MODAL: DETALHES DA SESS√ÉO (Status e A√ß√µes) -->
<div id="modal-event-details" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box">
        <button class="modal-close-btn" id="close-event-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <h3 style="margin-top: 0; color: #1B4332;">Detalhes da Sess√£o</h3>
        
        <div style="margin-bottom: 20px;">
            <h2 id="evt-patient-name" style="margin: 0; font-size: 1.4rem; color: #333;">Nome do Paciente</h2>
            <p id="evt-time-info" style="color: #666; margin: 5px 0;">Data e Hora</p>
        </div>

        <div style="background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 20px;">
            <label style="display: block; font-size: 0.85rem; color: #666; margin-bottom: 8px;">Status do Atendimento:</label>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn-status" data-status="done" style="flex: 1; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    ‚úÖ Realizado
                </button>
                <button class="btn-status" data-status="missed" style="flex: 1; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    ‚ùå Falta
                </button>
                <button class="btn-status" data-status="rescheduled" style="flex: 1; background: #fff; border: 1px solid #ddd; padding: 10px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px;">
                    üóìÔ∏è Reagendar
                </button>
            </div>
        </div>

        <!-- Op√ß√µes condicionais -->
        <div id="evt-options-done" style="display: none; margin-bottom: 20px;">
            <div class="form-group">
                <label>Valor Cobrado (R$)</label>
                <input type="number" id="evt-value" class="form-control" style="width: 100%; box-sizing: border-box;">
            </div>
        </div>

        <div id="evt-options-missed" style="display: none; margin-bottom: 20px;">
            <div class="form-group-checkbox" style="display: flex; align-items: center; gap: 10px;">
                <input type="checkbox" id="evt-charge-missed">
                <label for="evt-charge-missed" style="margin: 0;">Cobrar sess√£o mesmo com falta?</label>
            </div>
        </div>

        <div class="form-actions" style="justify-content: flex-end; display: flex; gap: 10px;">
            <button type="button" id="btn-save-event-status" class="btn btn-principal">Salvar Status</button>
        </div>
    </div>
</div>

<script>
    // --- L√ìGICA DO FRONTEND (MOCK) ---
    (function() {
        // Dados Mockados
        let patients = [
            { id: 1, name: 'Ana Clara Souza', phone: '(11) 99999-1111', automated: true, sessionValue: 150, status: 'ativo' },
            { id: 2, name: 'Bruno Mendes', phone: '(11) 98888-2222', automated: false, sessionValue: 200, status: 'ativo' },
            { id: 3, name: 'Carla Dias', phone: '(21) 97777-3333', automated: true, sessionValue: 180, status: 'inativo' }
        ];
        
        // Eventos com status: 'scheduled', 'done', 'missed'
        let events = [
            { id: 'e1', title: 'Ana Clara', start: '2026-01-20T10:00:00', end: '2026-01-20T11:00:00', patientId: 1, status: 'scheduled', value: 150 },
            { id: 'e2', title: 'Bruno M.', start: '2026-01-19T14:00:00', end: '2026-01-19T15:00:00', patientId: 2, status: 'done', value: 200 },
            { id: 'e3', title: 'Carla Dias', start: '2026-01-21T09:00:00', end: '2026-01-21T10:00:00', patientId: 3, status: 'scheduled', value: 180 }
        ];

        // Elementos DOM

        const listContainer = document.getElementById('patient-list');
        const countBadge = document.getElementById('patient-count');
        const searchInput = document.getElementById('search-patient');
        const statusFilter = document.getElementById('filter-patient-status');
        const pStatusInput = document.getElementById('p-status');
        const modal = document.getElementById('modal-patient');
        const form = document.getElementById('form-patient');
        const pIdInput = document.getElementById('p-id');
        const btnDelete = document.getElementById('btn-delete-patient');

        // Elementos do Modal de Agendamento
        const modalAppt = document.getElementById('modal-appointment');
        const formAppt = document.getElementById('form-appointment');
        const selectPatient = document.getElementById('appt-patient');

        // --- CUSTOM SELECT (FILTRO DE STATUS) ---
        const statusFilterWrapper = document.querySelector('.custom-select-wrapper');
        const statusFilterTrigger = document.getElementById('status-filter-trigger');
        const statusFilterOptions = document.getElementById('status-filter-options');
        const statusFilterSelectedText = document.getElementById('status-filter-selected-text');

        if (statusFilterTrigger) {
            statusFilterTrigger.addEventListener('click', () => {
                statusFilterWrapper.classList.toggle('open');
            });

            statusFilterOptions.addEventListener('click', (e) => {
                if (e.target.classList.contains('custom-option')) {
                    const oldSelected = statusFilterOptions.querySelector('.custom-option.selected');
                    if (oldSelected) oldSelected.classList.remove('selected');
                    
                    e.target.classList.add('selected');
                    
                    const newValue = e.target.getAttribute('data-value');
                    const newText = e.target.textContent;

                    statusFilterSelectedText.textContent = newText;
                    statusFilter.value = newValue; // Atualiza o input hidden

                    statusFilterWrapper.classList.remove('open');
                    renderList(searchInput.value, newValue);
                }
            });

            window.addEventListener('click', (e) => {
                if (statusFilterWrapper && !statusFilterWrapper.contains(e.target)) {
                    statusFilterWrapper.classList.remove('open');
                }
            });
        }

        // Elementos Financeiros
        const modalEvent = document.getElementById('modal-event-details');
        
        // --- RENDERIZAR PR√ìXIMAS SESS√ïES ---
        function renderNextSessions() {
            const container = document.getElementById('next-sessions-container');
            const list = document.getElementById('next-sessions-list');
            list.innerHTML = '';

            // Filtra eventos futuros e agendados
            // Ajuste: Filtra eventos com status 'scheduled'
            const upcoming = events
                .filter(e => e.status === 'scheduled')
                .sort((a, b) => new Date(a.start) - new Date(b.start))
                .slice(0, 5); // Pega os 5 primeiros

            if (upcoming.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            upcoming.forEach(evt => {
                const dateObj = new Date(evt.start);
                const timeStr = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const dateStr = dateObj.toLocaleDateString([], { day: '2-digit', month: 'short' });
                
                const el = document.createElement('div');
                el.className = 'next-session-card';
                el.innerHTML = `
                    <div class="ns-time"><span>${timeStr}</span><span style="font-size:0.7rem; font-weight:normal;">${dateStr}</span></div>
                    <div class="ns-info">
                        <h5>${evt.title}</h5>
                        <span>${evt.status === 'scheduled' ? 'Confirmado' : 'Pendente'}</span>
                    </div>
                    <div style="color:#ccc;">‚ûî</div>
                `;
                el.onclick = () => openEventDetails(evt); // Reutiliza a fun√ß√£o de abrir detalhes
                list.appendChild(el);
            });
        }

        // 1. Renderizar Lista
        function renderList(searchTerm = '', statusFilterValue = 'ativo') {
            listContainer.innerHTML = '';
            const filteredByName = patients.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));

            const finalFiltered = filteredByName.filter(p => {
                if (statusFilterValue === 'todos') return true;
                // Garante que pacientes sem status sejam tratados como ativos no filtro padr√£o
                return (p.status || 'ativo') === statusFilterValue;
            });
            
            countBadge.textContent = finalFiltered.length;

            // Atualiza o select do modal de agendamento
            selectPatient.innerHTML = '<option value="">Selecione...</option>';
            patients.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.name; // Usando nome como ID simplificado
                opt.textContent = p.name;
                selectPatient.appendChild(opt);
            });

            if (finalFiltered.length === 0) {
                listContainer.innerHTML = '<div class="empty-state-patients"><p>Nenhum paciente encontrado.</p></div>';
                return;
            }

            finalFiltered.forEach(p => {
                // Gera iniciais para o avatar
                const initials = p.name.split(' ').map(n => n[0]).slice(0, 2).join('').toUpperCase();

                const item = document.createElement('div');
                item.className = 'patient-card';
                item.innerHTML = `
                    <div class="patient-avatar">${initials}</div>
                    <div class="patient-info">
                        <h4>${p.name}</h4>
                        <span>${p.phone}</span>
                    </div>
                    <span class="patient-status-badge status-${p.status || 'ativo'}">${p.status || 'ativo'}</span>
                    <div class="patient-status" title="${p.automated ? 'Assistente Ativa' : 'Assistente Inativa'}">
                        ${p.automated ? 'ü§ñ' : 'üîï'}
                    </div>
                    <div style="font-weight:bold; color:#1B4332; font-size:0.9rem; margin-left: 10px;">R$ ${p.sessionValue || 0}</div>
                `;
                
                // Clique no card abre edi√ß√£o
                item.onclick = () => openEditModal(p);
                
                listContainer.appendChild(item);
            });
        }

        // 2. Inicializar Calend√°rio (FullCalendar)
        function initCalendar() {
            const calendarEl = document.getElementById('calendar-wrapper');
            if (!calendarEl) return;

            const mobile = window.innerWidth < 768;
            const isDesktop = window.innerWidth >= 992;

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: mobile ? 'timeGridDay' : 'timeGridWeek', // Mobile: Dia | Desktop: Semana
                locale: 'pt-br',
                selectable: true, // Permite sele√ß√£o visual
                editable: true, // Habilita arrastar e soltar (Drag & Drop)
                eventDrop: function(info) {
                    // Atualiza o hor√°rio no array local (Mock)
                    const evt = events.find(e => e.id == info.event.id);
                    if (evt) {
                        evt.start = info.event.start.toISOString();
                        evt.end = info.event.end ? info.event.end.toISOString() : null;
                        if(window.showToast) window.showToast('Sess√£o reagendada para ' + info.event.start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), 'success');
                    }
                },
                eventResize: function(info) {
                    // Atualiza a dura√ß√£o no array local
                    const evt = events.find(e => e.id == info.event.id);
                    if (evt) {
                        evt.end = info.event.end.toISOString();
                        if(window.showToast) window.showToast('Dura√ß√£o da sess√£o atualizada.', 'success');
                    }
                },
                headerToolbar: mobile ? {
                    left: 'title',
                    right: 'prev,next'
                } : {
                    left: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay today prev,next'
                },
                buttonText: {
                    today: 'Hoje',
                    month: 'M√™s',
                    week: 'Semana',
                    day: 'Dia'
                },
                slotMinTime: '00:00:00',
                slotMaxTime: '24:00:00',
                scrollTime: '07:00:00',
                allDaySlot: false,
                slotDuration: '01:00:00', // Slots de 1 hora para ficar mais limpo
                height: isDesktop ? '100%' : '75vh', // Desktop: 100% | Mobile: 75vh para scroll interno
                nowIndicator: true, // Indicador de hora atual
                titleFormat: mobile ? { year: 'numeric', month: 'short', day: 'numeric' } : undefined,
                
                // --- CONFIGURA√á√ïES MOBILE ---
                windowResize: function(arg) {
                    const width = window.innerWidth;
                    const isSmall = width < 768;
                    calendar.setOption('height', width >= 992 ? '100%' : '75vh');

                    if (isSmall) {
                        calendar.changeView('timeGridDay');
                        calendar.setOption('headerToolbar', {
                            left: 'prev,next',
                            center: 'title',
                            right: 'today'
                        });
                        calendar.setOption('titleFormat', { year: 'numeric', month: 'short', day: 'numeric' });
                    } else {
                        calendar.changeView('timeGridWeek');
                        calendar.setOption('headerToolbar', {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        });
                        calendar.setOption('titleFormat', undefined);
                    }
                },
                views: {
                    timeGridDay: {
                        titleFormat: { year: 'numeric', month: 'short', day: 'numeric' } // T√≠tulo curto no mobile
                    }
                },

                events: events.map(evt => ({
                    ...evt,
                    // Cores: Agendado (Verde), Realizado (Cinza), Falta (Vermelho)
                    color: evt.status === 'scheduled' ? '#1B4332' : (evt.status === 'done' ? '#9e9e9e' : '#d32f2f')
                })),
                // Clique em um hor√°rio vazio
                dateClick: function(info) {
                    const date = info.date;
                    // Ajusta fuso hor√°rio local para os inputs
                    const dateStr = date.toLocaleDateString('en-CA'); // YYYY-MM-DD
                    const timeStr = date.toTimeString().split(' ')[0].substring(0, 5); // HH:MM
                    
                    openAppointmentModal(dateStr, timeStr);
                },
                // Clique em um evento existente
                eventClick: function(info) {
                    openEventDetails(info.event);
                }
            });
            calendar.render();
            window.calendarApi = calendar;

            // --- SWIPE NAVIGATION (MOBILE) ---
            let touchStartX = 0;
            let touchEndX = 0;
            
            calendarEl.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
            }, {passive: true});

            calendarEl.addEventListener('touchend', e => {
                touchEndX = e.changedTouches[0].screenX;
                if (touchEndX < touchStartX - 50) calendar.next(); // Swipe Left -> Pr√≥ximo
                if (touchEndX > touchStartX + 50) calendar.prev(); // Swipe Right -> Anterior
            }, {passive: true});
        }

        // 3. Fun√ß√µes do Modal
        function openEditModal(patient) {
            form.reset();
            pIdInput.value = patient.id;
            document.getElementById('p-name').value = patient.name;
            document.getElementById('p-phone').value = patient.phone;
            document.getElementById('p-session-value').value = patient.sessionValue;
            pStatusInput.value = patient.status || 'ativo';
            document.getElementById('p-automated-msg').checked = patient.automated;
            
            document.getElementById('modal-patient-title').textContent = 'Editar Paciente';
            btnDelete.style.display = 'block'; // Mostra lixeira
            modal.style.display = 'flex';
        }

        function openNewPatientModal() {
            form.reset();
            pIdInput.value = ''; // Limpa ID para indicar novo
            document.getElementById('modal-patient-title').textContent = 'Novo Paciente';
            pStatusInput.value = 'ativo';
            btnDelete.style.display = 'none'; // Esconde lixeira
            modal.style.display = 'flex';
        }

        function openAppointmentModal(dateStr, timeStr) {
            formAppt.reset();
            if(dateStr) document.getElementById('appt-date').value = dateStr;
            if(timeStr) document.getElementById('appt-time').value = timeStr;
            
            document.getElementById('modal-appointment-title').textContent = 'Novo Agendamento';
            modalAppt.style.display = 'flex';
        }

        document.getElementById('btn-add-patient').onclick = () => {
            form.reset();
            pIdInput.value = ''; // Limpa ID para indicar novo
            pStatusInput.value = 'ativo';
            document.getElementById('modal-patient-title').textContent = 'Novo Paciente';
            btnDelete.style.display = 'none'; // Esconde lixeira
            modal.style.display = 'flex';
        };
        
        const closeModal = () => modal.style.display = 'none';
        document.getElementById('close-patient-modal').onclick = closeModal;
        document.getElementById('cancel-patient-modal').onclick = closeModal;

        const closeApptModal = () => modalAppt.style.display = 'none';
        document.getElementById('close-appointment-modal').onclick = closeApptModal;
        document.getElementById('cancel-appointment-modal').onclick = closeApptModal;

        // Fechar modais financeiros
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.addEventListener('click', () => document.querySelectorAll('.custom-modal-overlay').forEach(m => m.style.display = 'none'));
        });

        // Excluir Paciente
        btnDelete.onclick = () => {
            if(confirm('Tem certeza que deseja excluir este paciente?')) {
                patients = patients.filter(p => p.id != pIdInput.value);
                renderList(searchInput.value, statusFilter.value);
                closeModal();
                if(window.showToast) window.showToast('Paciente removido.', 'success');
            }
        };

        // Salvar (Novo ou Edi√ß√£o)
        form.onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('p-name').value;
            const phone = document.getElementById('p-phone').value;
            const automated = document.getElementById('p-automated-msg').checked;
            const sessionValue = parseFloat(document.getElementById('p-session-value').value) || 0;
            const status = pStatusInput.value;
            const id = pIdInput.value;

            if (id) {
                // Edi√ß√£o
                const index = patients.findIndex(p => p.id == id);
                if (index > -1) {
                    patients[index] = { ...patients[index], name, phone, automated, sessionValue, status };
                    if(window.showToast) window.showToast('Dados atualizados!', 'success');
                }
            } else {
                // Novo
                patients.push({
                    id: Date.now(),
                    name,
                    phone,
                    automated,
                    sessionValue,
                    status
                });
                if(window.showToast) window.showToast('Paciente adicionado com sucesso!', 'success');
            }
            
            renderList(searchInput.value, statusFilter.value);
            closeModal();
        };

        // Salvar Agendamento
        formAppt.onsubmit = (e) => {
            e.preventDefault();
            if(window.showToast) window.showToast('Agendamento realizado!', 'success');
            closeApptModal();
            // Aqui voc√™ adicionaria o evento ao calend√°rio via calendar.addEvent()
        };

        // --- L√ìGICA DE DETALHES DO EVENTO ---
        let currentEventId = null;
        function openEventDetails(fcEvent) {
            const evt = events.find(e => e.id == fcEvent.id);
            if(!evt) return;
            
            currentEventId = evt.id;
            document.getElementById('evt-patient-name').textContent = evt.title;
            document.getElementById('evt-time-info').textContent = new Date(evt.start).toLocaleString('pt-BR');
            document.getElementById('evt-value').value = evt.value;
            
            // Reset UI
            document.querySelectorAll('.btn-status').forEach(b => {
                b.style.background = '#fff'; b.style.color = '#333'; b.style.borderColor = '#ddd';
            });
            document.getElementById('evt-options-done').style.display = 'none';
            document.getElementById('evt-options-missed').style.display = 'none';

            // Seleciona status atual se houver
            if(evt.status) {
                const btn = document.querySelector(`.btn-status[data-status="${evt.status}"]`);
                if(btn) highlightStatusBtn(btn, evt.status);
                if(evt.status === 'done') document.getElementById('evt-options-done').style.display = 'block';
                if(evt.status === 'missed') document.getElementById('evt-options-missed').style.display = 'block';
            }

            modalEvent.style.display = 'flex';
        }

        function highlightStatusBtn(btn, status) {
            if(status === 'done') { btn.style.background = '#e8f5e9'; btn.style.borderColor = '#1B4332'; btn.style.color = '#1B4332'; }
            if(status === 'missed') { btn.style.background = '#ffebee'; btn.style.borderColor = '#d32f2f'; btn.style.color = '#d32f2f'; }
            if(status === 'rescheduled') { btn.style.background = '#fff3e0'; btn.style.borderColor = '#f57c00'; btn.style.color = '#f57c00'; }
        }

        document.querySelectorAll('.btn-status').forEach(btn => {
            btn.onclick = () => {
                const status = btn.dataset.status;
                document.querySelectorAll('.btn-status').forEach(b => {
                    b.style.background = '#fff'; b.style.color = '#333'; b.style.borderColor = '#ddd';
                });
                highlightStatusBtn(btn, status);
                document.getElementById('evt-options-done').style.display = status === 'done' ? 'block' : 'none';
                document.getElementById('evt-options-missed').style.display = status === 'missed' ? 'block' : 'none';
            };
        });

        document.getElementById('btn-save-event-status').onclick = () => {
            const activeBtn = document.querySelector('.btn-status[style*="background"]');
            if(!activeBtn) return;
            
            const status = activeBtn.dataset.status;
            const evtIdx = events.findIndex(e => e.id == currentEventId);
            
            if(evtIdx > -1) {
                events[evtIdx].status = status;
                if(status === 'done') {
                    events[evtIdx].value = parseFloat(document.getElementById('evt-value').value);
                }
                const fcEvent = window.calendarApi.getEventById(currentEventId);
                if(fcEvent) {
                    fcEvent.setProp('color', status === 'done' ? '#1B4332' : (status === 'missed' ? '#d32f2f' : '#3788d8'));
                }
            }
            modalEvent.style.display = 'none';
            if(window.showToast) window.showToast('Status atualizado!', 'success');
            renderNextSessions(); // Atualiza a lista r√°pida
        };


        searchInput.oninput = (e) => renderList(e.target.value, statusFilter.value);

        // Inicializa√ß√£o
        renderList('', 'ativo');
        renderNextSessions();
        // Pequeno delay para garantir que o DOM renderizou o container do calend√°rio
        setTimeout(initCalendar, 100);

        // M√°scara de telefone (se IMask estiver dispon√≠vel)
        if (typeof IMask !== 'undefined') {
            IMask(document.getElementById('p-phone'), { mask: '(00) 00000-0000' });
        }

        // Valida√ß√£o do campo Valor da Sess√£o (Impedir letras 'e', 'E', '+', '-')
        const sessionInput = document.getElementById('p-session-value');
        if (sessionInput) {
            sessionInput.addEventListener('keydown', (e) => {
                if (['e', 'E', '+', '-'].includes(e.key)) {
                    e.preventDefault();
                }
            });
        }
    })();
</script>