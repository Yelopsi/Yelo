<div class="main-header">
    <div class="header-content">
        <h1>Gest√£o Financeira</h1>
        <p>Acompanhe o fluxo de caixa, receitas e despesas do seu consult√≥rio.</p>
    </div>
</div>

<!-- A√ß√µes e Filtros -->
<div class="finance-controls-row" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
    <div style="display: flex; gap: 10px;">
        <button id="btn-export-report" class="btn" style="background-color: #fff; color: #1B4332; display: flex; align-items: center; gap: 8px; border: 1px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <span style="font-size: 1.2rem; line-height: 0;">‚¨á</span> Exportar
        </button>
        <button id="btn-add-expense" class="btn" style="background-color: #fff; color: #d32f2f; display: flex; align-items: center; gap: 8px; border: 1px solid #e0e0e0; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <span style="font-size: 1.2rem; line-height: 0;">-</span> Lan√ßar Despesa
        </button>
    </div>
    <div style="display: flex; align-items: center; gap: 10px;">
        <label style="color: #666; font-size: 0.9rem;">Per√≠odo:</label>
        <select id="fin-period-filter" class="form-control" style="width: auto; padding: 8px 15px; border-radius: 8px;">
            <option value="current">Este M√™s</option>
            <option value="last">M√™s Passado</option>
            <option value="year">Este Ano</option>
        </select>
    </div>
</div>

<!-- Cards de KPI -->
<div class="financial-grid">
    <div class="fin-card">
        <div class="card-header-row">
            <h4>Receita Realizada</h4>
            <span class="info-tooltip" tabindex="0" data-tooltip="Soma das sess√µes marcadas como 'Realizado' na agenda.">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </span>
        </div>
        <div class="fin-value positive" id="fin-income">R$ 0,00</div>
        <small style="color: #888;">Sess√µes pagas/realizadas</small>
    </div>
    <div class="fin-card">
        <div class="card-header-row">
            <h4>A Receber (Previsto)</h4>
            <span class="info-tooltip" tabindex="0" data-tooltip="Soma das sess√µes agendadas que ainda n√£o foram realizadas.">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </span>
        </div>
        <div class="fin-value neutral" id="fin-pending">R$ 0,00</div>
        <small style="color: #888;">Agendamentos futuros</small>
    </div>
    <div class="fin-card">
        <div class="card-header-row">
            <h4>Despesas</h4>
            <span class="info-tooltip" tabindex="0" data-tooltip="Total de despesas lan√ßadas manualmente no sistema.">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </span>
        </div>
        <div class="fin-value negative" id="fin-expenses">R$ 0,00</div>
        <small style="color: #888;">Gastos do consult√≥rio</small>
    </div>
    <div class="fin-card" style="background: #f0fdf4; border-color: #bbf7d0;">
        <div class="card-header-row">
            <h4>Saldo L√≠quido</h4>
            <span class="info-tooltip" tabindex="0" data-tooltip="Resultado da Receita Realizada menos as Despesas.">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </span>
        </div>
        <div class="fin-value positive" id="fin-balance">R$ 0,00</div>
        <small style="color: #166534;">Lucro do per√≠odo</small>
    </div>
</div>

<div class="fin-charts-row">
    <!-- Gr√°fico -->
    <div class="widget">
        <h3 class="widget-title">Fluxo de Caixa</h3>
        <div style="height: 250px;">
            <canvas id="financeChart"></canvas>
        </div>
    </div>

    <!-- √öltimas Movimenta√ß√µes -->
    <div class="fin-table-container">
        <h3 class="widget-title" style="margin-bottom: 15px;">Extrato Recente</h3>
        <div style="overflow-y: auto; max-height: 250px;">
            <table class="fin-table">
                <thead>
                    <tr>
                        <th>Descri√ß√£o</th>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Tipo</th>
                    </tr>
                </thead>
                <tbody id="fin-transactions-body">
                    <!-- Injetado via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- MODAL: LAN√áAR DESPESA -->
<div id="modal-expense" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box">
        <button class="modal-close-btn" id="close-expense-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <h3 style="margin-top: 0; color: #d32f2f;">Nova Despesa</h3>
        
        <form id="form-expense">
            <div class="form-group">
                <label>Descri√ß√£o</label>
                <input type="text" id="exp-desc" required placeholder="Ex: Aluguel, Internet, Supervis√£o...">
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>Valor (R$)</label>
                    <input type="number" id="exp-value" required step="0.01" placeholder="0,00">
                </div>
                <div class="form-group" style="flex: 1;">
                    <label>Data</label>
                    <input type="date" id="exp-date" required>
                </div>
            </div>
            <div class="form-actions" style="justify-content: flex-end; margin-top: 20px;">
                <button type="submit" class="btn btn-principal" style="background-color: #d32f2f;">Registrar Sa√≠da</button>
            </div>
        </form>
    </div>
</div>

<style>
    /* --- Custom Month Picker Styles (Yelo Aesthetic) --- */
    .custom-month-trigger {
        width: 100%;
        padding: 15px;
        border-radius: 12px;
        border: 2px solid #e0e0e0;
        font-size: 1.1rem;
        background-color: #f9f9f9;
        color: #333;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s;
        box-sizing: border-box;
    }
    .custom-month-trigger:hover {
        border-color: #1B4332;
        background-color: #fff;
    }
    .custom-month-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        z-index: 100;
        padding: 20px;
        margin-top: 8px;
        box-sizing: border-box;
        animation: fadeIn 0.2s ease-out;
    }
    .picker-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }
    .picker-btn { background: none; border: none; cursor: pointer; color: #1B4332; font-weight: bold; font-size: 1.2rem; padding: 5px 10px; border-radius: 50%; transition: background 0.2s; }
    .picker-btn:hover { background-color: #f0fdf4; }
    .picker-year { font-weight: 700; color: #1B4332; font-size: 1.1rem; }
    .month-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
    .month-option {
        padding: 10px; text-align: center; border-radius: 8px; cursor: pointer; font-size: 0.9rem; color: #555; transition: all 0.2s; border: 1px solid transparent;
    }
    .month-option:hover { background-color: #f0fdf4; color: #1B4332; border-color: #bbf7d0; }
    .month-option.selected { background-color: #1B4332; color: white; font-weight: 600; border-color: #1B4332; }

    /* --- Layout Responsivo (Corre√ß√£o Mobile) --- */
    .fin-charts-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 25px;
    }

    @media (max-width: 992px) {
        .fin-charts-row {
            grid-template-columns: 1fr;
        }
        
        .fin-table-container {
            width: 100%;
            overflow-x: auto;
        }
    }
</style>

<!-- MODAL: EXPORTAR EXTRATO -->
<div id="modal-export" class="custom-modal-overlay" style="display: none;">
    <div class="custom-modal-box" style="max-width: 500px; padding: 40px;">
        <button class="modal-close-btn" id="close-export-modal"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
        <h3 style="margin-top: 0; color: #1B4332;">Exportar Extrato</h3>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 20px;">Selecione o m√™s de refer√™ncia para o relat√≥rio.</p>
        
        <form id="form-export">
            <div class="form-group" style="position: relative;">
                <label style="font-size: 1rem; font-weight: 600; color: #1B4332; margin-bottom: 10px; display: block;">M√™s de Refer√™ncia</label>
                
                <div id="custom-month-picker" class="custom-month-trigger">
                    <span id="picker-display-text">Selecione...</span>
                    <span style="color: #1B4332;">üìÖ</span>
                </div>
                
                <div id="picker-dropdown" class="custom-month-dropdown">
                    <div class="picker-header"><button type="button" class="picker-btn" id="picker-prev-year">‚Üê</button><span id="picker-year-display" class="picker-year"></span><button type="button" class="picker-btn" id="picker-next-year">‚Üí</button></div>
                    <div class="month-grid" id="picker-month-grid"></div>
                </div>

                <input type="hidden" id="export-month" required>
            </div>
            <div class="form-actions" style="justify-content: flex-end; margin-top: 20px; display: flex; gap: 10px;">
                <button type="button" class="btn btn-secundario" id="cancel-export-modal">Cancelar</button>
                <button type="submit" class="btn btn-principal">Baixar Extrato</button>
            </div>
        </form>
    </div>
</div>

<script>
    (async function() {
        const BASE_URL = (typeof window.API_BASE_URL !== 'undefined') ? window.API_BASE_URL : 'http://localhost:3001';
        const token = localStorage.getItem('Yelo_token');

        let events = [];
        let expenses = [];

        const modalExpense = document.getElementById('modal-expense');

        // --- GEST√ÉO FINANCEIRA ---
        async function fetchFinancials(month = null) {
            try {
                let url = `${BASE_URL}/api/financials/dashboard`;
                if (month) url += `?month=${month}`;

                const res = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    events = data.appointments || [];
                    expenses = data.expenses || [];
                    updateUI();
                }
            } catch (error) {
                console.error("Erro ao buscar financeiro:", error);
            }
        }

        function updateUI() {
            const income = events.filter(e => e.status === 'done').reduce((acc, curr) => acc + (curr.value || 0), 0);
            const pending = events.filter(e => e.status === 'scheduled').reduce((acc, curr) => acc + (curr.value || 0), 0);
            const totalExpenses = expenses.reduce((acc, curr) => acc + (curr.value || 0), 0);

            document.getElementById('fin-income').textContent = `R$ ${income.toFixed(2)}`;
            document.getElementById('fin-pending').textContent = `R$ ${pending.toFixed(2)}`;
            document.getElementById('fin-expenses').textContent = `R$ ${totalExpenses.toFixed(2)}`;
            document.getElementById('fin-balance').textContent = `R$ ${(income - totalExpenses).toFixed(2)}`;

            const transactions = [
                ...events.filter(e => e.status === 'done').map(e => ({ desc: `Sess√£o: ${e.title}`, date: e.start, value: e.value, type: 'in' })),
                ...expenses.map(e => ({ desc: e.description, date: e.date, value: e.value, type: 'out' }))
            ].sort((a, b) => new Date(b.date) - new Date(a.date));

            const tbody = document.getElementById('fin-transactions-body');
            tbody.innerHTML = '';
            transactions.forEach(t => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${t.desc}</td>
                    <td class="fin-date">${new Date(t.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'})}</td>
                    <td>R$ ${t.value.toFixed(2)}</td>
                    <td><span class="${t.type === 'in' ? 'fin-type-in' : 'fin-type-out'}">${t.type === 'in' ? 'Entrada' : 'Sa√≠da'}</span></td>
                `;
                tbody.appendChild(row);
            });

            renderChart(income, totalExpenses);
        }

        // Gr√°fico (Chart.js)
        let chartInstance = null;
        function renderChart(income, expense) {
            const ctx = document.getElementById('financeChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Financeiro Atual'],
                    datasets: [
                        { label: 'Receitas', data: [income], backgroundColor: '#1B4332', borderRadius: 5 },
                        { label: 'Despesas', data: [expense], backgroundColor: '#d32f2f', borderRadius: 5 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Eventos
        document.getElementById('btn-add-expense').onclick = () => {
            document.getElementById('form-expense').reset();
            document.getElementById('exp-date').valueAsDate = new Date();
            modalExpense.style.display = 'flex';
        };

        document.getElementById('close-expense-modal').onclick = () => modalExpense.style.display = 'none';

        // --- EXPORTA√á√ÉO DE EXTRATO ---
        const modalExport = document.getElementById('modal-export');
        
        // L√≥gica do Custom Month Picker
        const pickerTrigger = document.getElementById('custom-month-picker');
        const pickerDropdown = document.getElementById('picker-dropdown');
        const pickerYearDisplay = document.getElementById('picker-year-display');
        const pickerMonthGrid = document.getElementById('picker-month-grid');
        const pickerDisplayText = document.getElementById('picker-display-text');
        const exportMonthInput = document.getElementById('export-month');
        
        let pickerDate = new Date(); // Data interna do picker
        const monthNames = ["Jan", "Fev", "Mar", "Abr", "Mai", "Jun", "Jul", "Ago", "Set", "Out", "Nov", "Dez"];

        function renderPicker() {
            pickerYearDisplay.textContent = pickerDate.getFullYear();
            pickerMonthGrid.innerHTML = '';
            
            monthNames.forEach((name, index) => {
                const el = document.createElement('div');
                el.className = 'month-option';
                el.textContent = name;
                
                // Verifica se √© o m√™s selecionado atualmente no input
                const currentVal = exportMonthInput.value; // YYYY-MM
                if (currentVal) {
                    const [y, m] = currentVal.split('-').map(Number);
                    if (y === pickerDate.getFullYear() && (m - 1) === index) {
                        el.classList.add('selected');
                    }
                }

                el.onclick = (e) => {
                    e.stopPropagation();
                    // Atualiza input
                    const monthStr = String(index + 1).padStart(2, '0');
                    const val = `${pickerDate.getFullYear()}-${monthStr}`;
                    exportMonthInput.value = val;
                    
                    // Atualiza texto
                    pickerDisplayText.textContent = `${name} de ${pickerDate.getFullYear()}`;
                    
                    // Fecha e re-renderiza para mostrar sele√ß√£o
                    pickerDropdown.style.display = 'none';
                    renderPicker();
                };
                pickerMonthGrid.appendChild(el);
            });
        }

        document.getElementById('picker-prev-year').onclick = (e) => { e.stopPropagation(); pickerDate.setFullYear(pickerDate.getFullYear() - 1); renderPicker(); };
        document.getElementById('picker-next-year').onclick = (e) => { e.stopPropagation(); pickerDate.setFullYear(pickerDate.getFullYear() + 1); renderPicker(); };
        
        pickerTrigger.onclick = (e) => {
            e.stopPropagation();
            pickerDropdown.style.display = pickerDropdown.style.display === 'block' ? 'none' : 'block';
            renderPicker();
        };

        // Fecha ao clicar fora
        window.addEventListener('click', (e) => {
            if (!pickerTrigger.contains(e.target) && !pickerDropdown.contains(e.target)) {
                pickerDropdown.style.display = 'none';
            }
        });
        
        document.getElementById('btn-export-report').onclick = () => {
            // Define o m√™s atual como padr√£o
            const now = new Date();
            const currentMonthVal = now.toISOString().slice(0, 7);
            exportMonthInput.value = currentMonthVal;
            
            // Atualiza visual
            pickerDate = new Date(now);
            const mIndex = now.getMonth();
            pickerDisplayText.textContent = `${monthNames[mIndex]} de ${now.getFullYear()}`;
            
            modalExport.style.display = 'flex';
        };

        document.getElementById('close-export-modal').onclick = () => modalExport.style.display = 'none';
        document.getElementById('cancel-export-modal').onclick = () => modalExport.style.display = 'none';

        document.getElementById('form-export').onsubmit = (e) => {
            e.preventDefault();
            const selectedMonth = document.getElementById('export-month').value; // YYYY-MM
            if (!selectedMonth) return;

            // Filtra transa√ß√µes pelo m√™s selecionado
            const transactions = [
                ...events.filter(e => e.status === 'done').map(e => ({ 
                    date: e.start, 
                    desc: e.title, // Nome do paciente
                    value: e.value, 
                    type: 'Entrada' 
                })),
                ...expenses.map(e => ({ 
                    date: e.date, 
                    desc: e.desc, 
                    value: -Math.abs(e.value), // Valor negativo para d√©bito
                    type: 'Sa√≠da' 
                }))
            ].filter(t => t.date.startsWith(selectedMonth)) // Filtro simples de string YYYY-MM
             .sort((a, b) => new Date(a.date) - new Date(b.date)); // Ordem cronol√≥gica

            // Gera CSV
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += `M√™s de refer√™ncia: ${selectedMonth}\n`;
            csvContent += "Data;Descri√ß√£o;Valor;Tipo\n";
            
            let saldoFinal = 0;

            transactions.forEach(t => {
                saldoFinal += t.value;
                const dateStr = new Date(t.date).toLocaleDateString('pt-BR');
                const desc = t.desc ? t.desc.replace(/"/g, '""') : "";
                const valStr = t.value.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                const row = `${dateStr};"${desc}";"${valStr}";${t.type}`;
                csvContent += row + "\n";
            });
            
            const saldoStr = saldoFinal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            csvContent += `;"SALDO FINAL";"${saldoStr}";\n`;

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Yelo_Extrato_Financeiro.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            modalExport.style.display = 'none';
        };

        document.getElementById('form-expense').onsubmit = async (e) => {
            e.preventDefault();
            const expenseData = {
                description: document.getElementById('exp-desc').value,
                value: parseFloat(document.getElementById('exp-value').value),
                date: document.getElementById('exp-date').value
            };

            try {
                const res = await fetch(`${BASE_URL}/api/financials/expenses`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}` 
                    },
                    body: JSON.stringify(expenseData)
                });

                if (res.ok) {
                    modalExpense.style.display = 'none';
                    fetchFinancials(); // Recarrega dados
                    if(window.showToast) window.showToast('Despesa registrada.', 'success');
                } else {
                    const errData = await res.json();
                    alert('Erro ao salvar: ' + (errData.error || 'Falha desconhecida'));
                }
            } catch (err) {
                console.error(err);
                alert('Erro de conex√£o ao salvar despesa.');
            }
        };

        // Inicializa√ß√£o
        fetchFinancials();

        // Filtro de Per√≠odo (Simples)
        document.getElementById('fin-period-filter').addEventListener('change', (e) => {
            const val = e.target.value;
            const now = new Date();
            let monthStr = null;

            if (val === 'current') {
                monthStr = now.toISOString().slice(0, 7);
            } else if (val === 'last') {
                now.setMonth(now.getMonth() - 1);
                monthStr = now.toISOString().slice(0, 7);
            }
            // 'year' exigiria l√≥gica extra no backend, por enquanto recarrega o padr√£o
            fetchFinancials(monthStr);
        });
    })();
</script>